# Saju피아 사용자 플로우 (User Flow)

**프로젝트**: Saju피아 - AI 기반 사주팔자 분석 SaaS
**작성일**: 2025-12-12
**버전**: 1.0

---

## 1. 신규 사용자 회원가입 및 Free 플랜 부여

### 1.1 입력
- 사용자가 랜딩 페이지에서 "무료 시작하기" 또는 "시작하기" 버튼 클릭
- 사용자가 Clerk 로그인 모달에서 "Google로 로그인" 선택
- Google OAuth 인증 완료

### 1.2 처리
1. Clerk가 Google OAuth 인증 프로세스 시작
2. 사용자가 Google 계정 선택 및 권한 승인
3. Clerk가 인증 토큰 생성 및 세션 수립
4. Clerk Webhook이 `user.created` 이벤트를 Next.js API로 전송
5. Next.js API (`/api/auth/webhook`)가 Webhook 서명 검증
6. Supabase `users` 테이블에 신규 사용자 레코드 생성
   - `clerk_user_id`: Clerk의 고유 ID 저장
   - `email`: 사용자 이메일 저장
   - `created_at`, `updated_at`: 현재 시간 저장
7. Supabase `subscriptions` 테이블에 Free 플랜 레코드 생성
   - `user_id`: 생성된 사용자 ID 참조
   - `plan`: 'free'
   - `status`: 'active'
   - `remaining_tests`: 3
   - `max_tests`: 3
   - `billing_key`: NULL
   - `cancel_at_period_end`: false
8. 사용자를 `/dashboard` 페이지로 리다이렉트

### 1.3 출력
- 사용자가 로그인된 상태로 대시보드 페이지 진입
- Global Nav 하단에 잔여 횟수 "3/3" 표시
- Global Nav 하단에 구독 플랜 "Free" 표시
- 사용자 이메일 표시
- 빈 검사 내역 상태 표시: "아직 검사 내역이 없습니다. 새 검사를 시작해보세요!"

### 1.4 엣지케이스
#### Case 1.4.1: 이미 가입한 사용자가 다시 로그인 시도
- **처리**: Clerk가 기존 세션 확인 후 즉시 로그인 처리
- **출력**: `/dashboard`로 리다이렉트, 기존 검사 내역 표시

#### Case 1.4.2: Google OAuth 인증 취소
- **처리**: Clerk가 인증 실패 감지
- **출력**: 로그인 모달에 "인증이 취소되었습니다" 메시지 표시, 랜딩 페이지로 유지

#### Case 1.4.3: Clerk Webhook 전송 실패
- **처리**: Clerk가 자동 재시도 (최대 3회)
- **출력**:
  - 재시도 성공 시: 정상 처리
  - 재시도 실패 시: Clerk에 로그인되었으나 Supabase에 사용자 미생성 → 앱 접근 시 에러 페이지 표시 및 관리자 알림

#### Case 1.4.4: Supabase 연결 실패
- **처리**: Webhook 핸들러에서 에러 캐치
- **출력**:
  - Clerk Webhook에 500 에러 응답 (Clerk가 재시도)
  - 로그에 에러 기록
  - 사용자에게 "일시적인 문제가 발생했습니다. 잠시 후 다시 시도해주세요" 메시지 표시

#### Case 1.4.5: 중복 Webhook 수신
- **처리**: `clerk_user_id`로 중복 체크, 이미 존재하면 스킵
- **출력**: 정상적으로 200 응답 반환, 중복 레코드 생성 방지

---

## 2. 새 검사 생성 및 AI 분석 실행

### 2.1 입력
- 사용자가 Global Nav에서 "새 검사" 메뉴 클릭 또는 대시보드에서 "새 검사 시작" 버튼 클릭
- `/new-test` 페이지 진입
- 사용자가 폼 필드 입력:
  - 이름 (필수)
  - 생년월일 (캘린더 선택, 필수)
  - 출생시간 (시간 선택, 선택)
  - "출생시간 모름" 체크박스 (선택)
  - 성별 (남성/여성, 필수)
- "검사 시작" 버튼 클릭

### 2.2 처리
1. 클라이언트 측 유효성 검증
   - 필수 필드 (이름, 생년월일, 성별) 입력 확인
   - "출생시간 모름" 체크 시 출생시간 필드 비활성화
2. `/api/test/create` POST 요청 전송
3. 서버 측 인증 확인 (Clerk 세션 검증)
4. Supabase에서 사용자의 구독 정보 조회
5. 잔여 횟수 확인 (`remaining_tests > 0`)
6. Supabase `tests` 테이블에 신규 레코드 생성
   - `user_id`: 현재 사용자 ID
   - `name`: 입력받은 이름
   - `birth_date`: 입력받은 생년월일
   - `birth_time`: 입력받은 출생시간 또는 NULL
   - `gender`: 입력받은 성별
   - `model_used`: 사용자 플랜에 따라 'flash' (Free) 또는 'pro' (Pro)
   - `analysis_result`: 초기값 NULL (AI 응답 대기)
7. 시스템 프롬프트 생성 (사용자 입력 정보 포함)
8. Gemini API 호출
   - Free 플랜: `gemini-2.5-flash` 모델 사용
   - Pro 플랜: `gemini-2.5-pro` 모델 사용
9. AI 응답 수신 및 마크다운 형식 검증
10. `tests` 테이블의 `analysis_result` 필드 업데이트
11. `subscriptions` 테이블의 `remaining_tests` 1 차감
12. 생성된 검사 ID 반환

### 2.3 출력
- 로딩 UI 표시: "AI가 당신의 사주를 분석하고 있습니다..." (프로그레스 바 또는 스피너)
- AI 분석 완료 후 `/analysis/[id]` 페이지로 리다이렉트
- Global Nav의 잔여 횟수 업데이트 (예: 3/3 → 2/3)
- 성공 토스트 메시지: "분석이 완료되었습니다!"

### 2.4 엣지케이스
#### Case 2.4.1: 잔여 횟수 0일 때 검사 시도
- **처리**:
  - 서버에서 `remaining_tests = 0` 감지
  - API가 403 Forbidden 에러 반환
- **출력**:
  - "검사 횟수를 모두 사용했습니다" 에러 메시지 표시
  - "Pro로 업그레이드" 버튼 표시
  - 버튼 클릭 시 `/subscription` 페이지로 이동

#### Case 2.4.2: Gemini API 응답 지연 (10초 초과)
- **처리**:
  - API 타임아웃 (예: 30초) 설정
  - 타임아웃 발생 시 에러 처리
- **출력**:
  - "AI 서버가 응답하지 않습니다. 잠시 후 다시 시도해주세요" 에러 메시지
  - 잔여 횟수 차감 롤백 (원복)
  - `tests` 테이블의 해당 레코드 삭제 또는 `status = 'failed'` 마킹

#### Case 2.4.3: Gemini API 에러 응답 (예: 429 Rate Limit)
- **처리**:
  - API 에러 코드 감지
  - 잔여 횟수 차감 롤백
- **출력**:
  - "일시적으로 서비스 이용이 제한되었습니다. 잠시 후 다시 시도해주세요" 에러 메시지
  - 로그에 에러 기록 (관리자 모니터링)
  - 사용자를 `/dashboard`로 리다이렉트

#### Case 2.4.4: 출생시간 미입력 (모름 체크 안 함)
- **처리**:
  - 클라이언트 측에서 출생시간을 선택적 필드로 처리
  - 서버에서 `birth_time = null` 허용
- **출력**:
  - Gemini 프롬프트에 "출생시간: 미상" 전달
  - AI가 출생시간 없이 분석 수행

#### Case 2.4.5: 중복 요청 (사용자가 검사 시작 버튼 연타)
- **처리**:
  - 클라이언트 측에서 버튼 비활성화 (첫 클릭 후)
  - 서버 측에서 동일 사용자의 동시 요청 감지 (예: 1초 이내 중복 요청)
- **출력**:
  - 첫 번째 요청만 처리
  - 이후 요청은 "이미 진행 중인 검사가 있습니다" 응답 반환

#### Case 2.4.6: 생년월일 미래 날짜 입력
- **처리**:
  - 클라이언트 측에서 캘린더 최대 날짜를 오늘로 제한
  - 서버 측에서도 날짜 검증 (오늘 이후 날짜 거부)
- **출력**:
  - "생년월일은 오늘 이전이어야 합니다" 에러 메시지

#### Case 2.4.7: 비인증 사용자 접근 시도
- **처리**:
  - Next.js Middleware에서 인증 상태 확인
  - 미인증 사용자 감지
- **출력**:
  - Clerk 로그인 페이지로 리다이렉트
  - 로그인 완료 후 `/new-test`로 다시 리다이렉트

---

## 3. 대시보드 검사 내역 조회

### 3.1 입력
- 사용자가 Global Nav에서 "대시보드" 메뉴 클릭
- `/dashboard` 페이지 진입
- (선택) 검색창에 이름 입력

### 3.2 처리
1. 페이지 로드 시 `/api/test/list` GET 요청
2. 서버 측 인증 확인 (Clerk 세션 검증)
3. Supabase에서 현재 사용자의 검사 내역 조회
   - `user_id`로 필터링
   - `created_at DESC` 정렬 (최신순)
4. 검사 데이터 반환 (이름, 생년월일, 검사 일시, 사용 모델)
5. 클라이언트에서 검색어가 있을 경우 이름 필터링
   - 검색어가 이름에 포함된 결과만 표시
6. 총 검사 건수 계산

### 3.3 출력
- 페이지 상단에 안내 문구 표시
- 검색창 표시 (플레이스홀더: "성함으로 검색하세요")
- 총 검사 건수 표시 (예: "총 5건의 검사 내역")
- 검사 내역 카드 그리드 표시:
  - 각 카드: 이름, 생년월일, 검사 일시, 모델 배지 (Flash/Pro)
  - 호버 시 커서 포인터 및 하이라이트 효과
- 빈 상태 (검사 내역 없을 때):
  - "아직 검사 내역이 없습니다. 새 검사를 시작해보세요!"
  - "새 검사 시작" 버튼
- 검색 결과 없을 때:
  - "검색 결과가 없습니다"
  - 검색어 초기화 버튼

### 3.4 엣지케이스
#### Case 3.4.1: 검사 내역이 매우 많을 때 (100건 이상)
- **처리**:
  - 서버 측에서 페이지네이션 구현 (예: 20건씩)
  - 무한 스크롤 또는 "더보기" 버튼
- **출력**:
  - 초기 로드 시 최근 20건만 표시
  - 스크롤 또는 버튼 클릭 시 추가 로드

#### Case 3.4.2: API 요청 실패 (네트워크 오류)
- **처리**:
  - 클라이언트에서 에러 캐치
  - 재시도 로직 (최대 3회)
- **출력**:
  - "검사 내역을 불러올 수 없습니다" 에러 메시지
  - "다시 시도" 버튼

#### Case 3.4.3: 검색어 입력 후 결과 없음
- **처리**:
  - 클라이언트 측 필터링으로 빈 배열 반환
- **출력**:
  - "검색 결과가 없습니다"
  - "검색어를 확인하거나 초기화해주세요" 안내 메시지
  - 검색어 초기화 (X) 버튼

#### Case 3.4.4: 검색어에 특수문자 포함
- **처리**:
  - 클라이언트 측에서 특수문자 허용 (이름에 포함될 수 있음)
  - SQL Injection 방지를 위해 서버 측 검색 시 파라미터화된 쿼리 사용
- **출력**:
  - 정상적으로 검색 수행

---

## 4. 분석 상세보기

### 4.1 입력
- 사용자가 대시보드에서 검사 카드 클릭
- `/analysis/[id]` 페이지 진입 (id는 검사 고유 ID)

### 4.2 처리
1. `/api/test/[id]` GET 요청
2. 서버 측 인증 확인 (Clerk 세션 검증)
3. Supabase에서 해당 검사 데이터 조회
   - `id`로 검색
   - `user_id`도 함께 검증 (다른 사용자의 검사 접근 방지)
4. 검사 데이터 반환:
   - 이름, 생년월일, 출생시간, 성별
   - 사용 모델, 검사 일시
   - AI 분석 결과 (마크다운)
5. 클라이언트에서 마크다운 → HTML 변환
   - 라이브러리: `react-markdown` + `remark-gfm`

### 4.3 출력
- 사주 카페 분위기 UI:
  - 따뜻한 베이지/브라운 톤 배경
  - 전통적 아이콘 (별, 달, 태극 등)
- 상단 정보 카드:
  - 이름 (큰 글씨)
  - 생년월일, 출생시간 (또는 "시간 미상"), 성별
  - 사용 모델 배지
  - 분석 일시
- AI 분석 결과 섹션:
  - 마크다운 렌더링 (제목, 리스트, 인용구 스타일 적용)
  - 섹션별 구분:
    - 천간·지지 계산
    - 오행 분석
    - 대운·세운 해석
    - 성격/재운/건강운/연애운
- 하단 액션 버튼:
  - "대시보드로 돌아가기" (Secondary)
  - "새 검사 시작" (Primary)

### 4.4 엣지케이스
#### Case 4.4.1: 존재하지 않는 검사 ID 접근
- **처리**:
  - 서버에서 검사 데이터 조회 결과 없음
  - 404 Not Found 응답
- **출력**:
  - "검사를 찾을 수 없습니다" 에러 페이지
  - "대시보드로 돌아가기" 버튼

#### Case 4.4.2: 다른 사용자의 검사 접근 시도
- **처리**:
  - 서버에서 `user_id` 불일치 감지
  - 403 Forbidden 응답
- **출력**:
  - "접근 권한이 없습니다" 에러 페이지
  - "대시보드로 돌아가기" 버튼

#### Case 4.4.3: AI 분석 결과가 NULL (처리 중 실패한 케이스)
- **처리**:
  - 서버에서 `analysis_result = null` 감지
  - 200 응답이지만 특수 상태 플래그 반환
- **출력**:
  - "분석 결과가 아직 준비되지 않았습니다" 메시지
  - "대시보드로 돌아가기" 버튼
  - (향후 개선: 재분석 요청 기능)

#### Case 4.4.4: 마크다운 형식 오류 (Gemini 응답 이상)
- **처리**:
  - 클라이언트 측 마크다운 파서가 에러 방지 모드로 작동
  - 원본 텍스트 그대로 표시
- **출력**:
  - 분석 결과를 플레인 텍스트로 표시
  - "형식 변환 중 오류가 발생했습니다" 경고 메시지

---

## 5. Pro 구독 시작

### 5.1 입력
- 사용자가 다음 중 하나의 경로로 Pro 구독 시작:
  - 랜딩 페이지에서 "Pro 시작하기" 버튼 클릭
  - 대시보드에서 구독 정보 카드의 "Pro로 업그레이드" 버튼 클릭
  - `/subscription` 페이지에서 "Pro로 업그레이드" 버튼 클릭
  - 잔여 횟수 0일 때 "구독 업그레이드 필요" 안내의 버튼 클릭

### 5.2 처리
1. 토스페이먼츠 SDK 초기화 (`NEXT_PUBLIC_TOSS_CLIENT_KEY` 사용)
2. 빌링키 발급 요청 (자동결제 등록)
   - 고객 정보: 이메일, 이름 (Clerk에서 가져옴)
   - 성공 리다이렉트 URL: `/subscription?status=success`
   - 실패 리다이렉트 URL: `/subscription?status=fail`
3. 사용자가 결제 수단 입력 (카드 정보, 간편결제 등)
4. 토스페이먼츠가 빌링키 발급
5. 성공 리다이렉트 후 `/api/subscription/create` POST 요청
   - 빌링키 전달
6. 서버에서 토스페이먼츠 API로 첫 결제 실행 (3,900원)
7. 결제 성공 시:
   - Supabase `subscriptions` 테이블 업데이트:
     - `plan`: 'pro'
     - `status`: 'active'
     - `billing_key`: 토스페이먼츠 빌링키 저장
     - `current_period_start`: 오늘 날짜
     - `current_period_end`: 오늘 + 1개월
     - `remaining_tests`: 10
     - `max_tests`: 10
     - `cancel_at_period_end`: false
   - Supabase `payments` 테이블에 결제 내역 생성:
     - `user_id`, `subscription_id`
     - `amount`: 3900
     - `status`: 'success'
     - `toss_payment_key`: 토스페이먼츠 결제 키
8. 결제 실패 시:
   - 에러 로그 저장
   - 빌링키 삭제 (토스페이먼츠 API 호출)

### 5.3 출력
- **결제 성공 시**:
  - `/subscription` 페이지로 리다이렉트
  - 성공 토스트 메시지: "Pro 구독이 시작되었습니다!"
  - 구독 정보 카드 업데이트:
    - "Pro 플랜" 표시
    - 잔여 횟수: 10/10
    - 다음 결제일 표시
    - "구독 취소" 버튼 표시
  - Global Nav 업데이트:
    - 구독: "Pro"
    - 잔여 횟수: 10/10
- **결제 실패 시**:
  - `/subscription` 페이지로 리다이렉트
  - 에러 메시지: "결제에 실패했습니다. 다시 시도해주세요"
  - 구독 상태 변경 없음 (Free 유지)

### 5.4 엣지케이스
#### Case 5.4.1: 빌링키 발급 중 사용자가 취소
- **처리**:
  - 토스페이먼츠 SDK에서 사용자 취소 감지
  - 실패 리다이렉트 URL로 이동
- **출력**:
  - "결제가 취소되었습니다" 메시지
  - 구독 상태 변경 없음

#### Case 5.4.2: 첫 결제 실패 (카드 한도 초과 등)
- **처리**:
  - 토스페이먼츠 API에서 결제 실패 응답
  - 서버에서 빌링키 삭제 API 호출
  - `payments` 테이블에 실패 레코드 저장
- **출력**:
  - "결제에 실패했습니다. 결제 수단을 확인해주세요" 에러 메시지
  - 구독 상태 변경 없음

#### Case 5.4.3: 이미 Pro 구독 중인 사용자가 다시 시도
- **처리**:
  - 서버에서 현재 구독 상태 확인
  - `plan = 'pro'` 및 `status = 'active'` 감지
  - API가 409 Conflict 응답
- **출력**:
  - "이미 Pro 구독 중입니다" 메시지
  - 구독 관리 페이지로 리다이렉트

#### Case 5.4.4: 토스페이먼츠 API 타임아웃
- **처리**:
  - 서버 측 타임아웃 설정 (예: 30초)
  - 타임아웃 발생 시 에러 처리
- **출력**:
  - "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요" 에러 메시지
  - 빌링키 삭제 시도 (정리)

#### Case 5.4.5: 빌링키 발급 성공 후 서버 API 호출 전 페이지 이탈
- **처리**:
  - 리다이렉트 URL에서 빌링키 쿼리 파라미터 확인
  - 빌링키가 있지만 DB에 구독 없음 감지
  - 사용자가 다시 페이지 진입 시 재시도 안내
- **출력**:
  - "결제 처리가 완료되지 않았습니다. 다시 시도해주세요" 메시지
  - 고객센터 연락처 안내 (수동 처리 필요 시)

---

## 6. 구독 취소

### 6.1 입력
- 사용자가 `/subscription` 페이지의 "구독 취소" 버튼 클릭
- 확인 모달에서 "취소하기" 버튼 클릭

### 6.2 처리
1. 확인 모달 표시:
   - "구독을 취소하시겠습니까?"
   - 안내 문구: "다음 결제일(YYYY-MM-DD)까지 서비스를 계속 이용하실 수 있습니다"
   - 안내 문구: "결제일 이전에는 언제든지 취소를 철회할 수 있습니다"
   - 안내 문구: "환불은 불가합니다"
2. 사용자가 "취소하기" 확인 시 `/api/subscription/cancel` POST 요청
3. 서버 측 인증 확인
4. Supabase `subscriptions` 테이블 업데이트:
   - `cancel_at_period_end`: true
   - `status`: 'active' 유지 (다음 결제일까지)
5. 성공 응답 반환

### 6.3 출력
- 확인 모달 닫힘
- 성공 토스트 메시지: "구독 취소가 예약되었습니다"
- 구독 정보 카드 업데이트:
  - "취소 예정" 배지 표시
  - "다음 결제일(YYYY-MM-DD)에 구독이 종료됩니다" 경고 메시지
  - "구독 취소" 버튼 → "취소 철회" 버튼으로 변경
- 잔여 횟수 및 서비스 이용 가능 상태 유지

### 6.4 엣지케이스
#### Case 6.4.1: 확인 모달에서 "돌아가기" 클릭
- **처리**:
  - 모달 닫기
  - API 호출 없음
- **출력**:
  - 구독 상태 변경 없음
  - 페이지 상태 유지

#### Case 6.4.2: Free 플랜 사용자가 취소 시도
- **처리**:
  - 클라이언트에서 Free 플랜 시 "구독 취소" 버튼 숨김
  - 서버에서도 검증: `plan = 'free'` 감지 시 400 Bad Request
- **출력**:
  - "취소할 구독이 없습니다" 에러 메시지

#### Case 6.4.3: 이미 취소 예약된 구독을 다시 취소 시도
- **처리**:
  - 서버에서 `cancel_at_period_end = true` 감지
  - API가 409 Conflict 응답
- **출력**:
  - "이미 취소 예약되었습니다" 메시지

#### Case 6.4.4: API 호출 실패 (네트워크 오류)
- **처리**:
  - 클라이언트에서 에러 캐치
  - 재시도 안내
- **출력**:
  - "구독 취소에 실패했습니다. 다시 시도해주세요" 에러 메시지

---

## 7. 구독 취소 철회

### 7.1 입력
- 사용자가 취소 예약된 상태에서 `/subscription` 페이지의 "취소 철회" 버튼 클릭

### 7.2 처리
1. `/api/subscription/reactivate` POST 요청
2. 서버 측 인증 확인
3. Supabase `subscriptions` 테이블에서 현재 구독 조회
4. 취소 예약 상태 확인 (`cancel_at_period_end = true`)
5. 다음 결제일이 아직 도래하지 않았는지 확인 (`current_period_end > 오늘`)
6. Supabase `subscriptions` 테이블 업데이트:
   - `cancel_at_period_end`: false
7. 성공 응답 반환

### 7.3 출력
- 성공 토스트 메시지: "구독 취소가 철회되었습니다"
- 구독 정보 카드 업데이트:
  - "취소 예정" 배지 제거
  - 경고 메시지 제거
  - "취소 철회" 버튼 → "구독 취소" 버튼으로 변경
- 다음 결제일에 정상적으로 자동 갱신 예정 안내

### 7.4 엣지케이스
#### Case 7.4.1: 다음 결제일이 이미 지난 후 철회 시도
- **처리**:
  - 서버에서 `current_period_end <= 오늘` 감지
  - 이미 구독이 만료되어 철회 불가
  - API가 400 Bad Request 응답
- **출력**:
  - "구독 기간이 만료되어 철회할 수 없습니다" 에러 메시지
  - "다시 구독하려면 새로운 결제가 필요합니다" 안내
  - "Pro 시작하기" 버튼 표시

#### Case 7.4.2: 취소 예약 상태가 아닌데 철회 시도
- **처리**:
  - 클라이언트에서 "취소 철회" 버튼 숨김
  - 서버에서도 검증: `cancel_at_period_end = false` 감지
  - API가 400 Bad Request 응답
- **출력**:
  - "철회할 취소 예약이 없습니다" 에러 메시지

#### Case 7.4.3: API 호출 실패
- **처리**:
  - 클라이언트에서 에러 캐치
- **출력**:
  - "철회에 실패했습니다. 다시 시도해주세요" 에러 메시지

---

## 8. 정기결제 자동 실행 (Supabase Cron)

### 8.1 입력
- Supabase Cron이 매일 02:00에 트리거
- Cron Job이 `/api/cron/daily-billing` POST 요청 전송
- 요청 헤더에 비밀 토큰 포함 (환경변수로 관리)

### 8.2 처리
1. 서버에서 비밀 토큰 검증 (Cron 요청 확인)
2. Supabase에서 오늘이 결제일인 구독 조회:
   - `current_period_end = 오늘`
   - `status = 'active'`
   - `cancel_at_period_end = false`
3. 각 구독에 대해 순차적으로 결제 처리:
   - **결제 실행**:
     - 토스페이먼츠 빌링키로 결제 API 호출 (3,900원)
     - 고객 정보: 사용자 이메일, 이름
   - **결제 성공 시**:
     - `remaining_tests`: 10으로 초기화
     - `current_period_start`: 오늘
     - `current_period_end`: 오늘 + 1개월
     - `payments` 테이블에 성공 레코드 저장
     - (선택) 사용자에게 결제 완료 이메일 발송
   - **결제 실패 시**:
     - `status`: 'expired'로 변경
     - `plan`: 'free'로 변경
     - `remaining_tests`: 0으로 설정
     - 토스페이먼츠 빌링키 삭제 API 호출
     - `billing_key`: NULL로 업데이트
     - `payments` 테이블에 실패 레코드 저장 (에러 메시지 포함)
     - (선택) 사용자에게 결제 실패 이메일 발송
4. 처리 결과 로그 저장 (성공 건수, 실패 건수)
5. 관리자에게 일일 결제 리포트 전송 (선택)

### 8.3 출력
- **사용자 측 (결제 성공)**:
  - 다음 로그인 시 잔여 횟수 10/10으로 갱신됨
  - 다음 결제일 업데이트됨
  - (선택) 이메일: "Pro 구독이 갱신되었습니다" + 결제 영수증
- **사용자 측 (결제 실패)**:
  - 다음 로그인 시 구독 플랜이 Free로 변경됨
  - 잔여 횟수 0/0 표시
  - (선택) 이메일: "결제에 실패하여 구독이 해지되었습니다" + 재구독 안내
- **서버 측**:
  - 로그에 결제 처리 결과 기록
  - (선택) 관리자 대시보드에 일일 리포트 표시

### 8.4 엣지케이스
#### Case 8.4.1: 비밀 토큰 불일치 (비정상 요청)
- **처리**:
  - 서버에서 토큰 검증 실패
  - API가 401 Unauthorized 응답
- **출력**:
  - 요청 거부
  - 로그에 비정상 접근 기록
  - (선택) 관리자에게 보안 알림

#### Case 8.4.2: 오늘이 결제일인 구독이 없음
- **처리**:
  - Supabase 쿼리 결과 빈 배열
  - 로그에 "오늘 처리할 결제 없음" 기록
- **출력**:
  - 200 OK 응답
  - 처리 종료

#### Case 8.4.3: 토스페이먼츠 API 일시적 장애
- **처리**:
  - 결제 API 호출 시 타임아웃 또는 5xx 에러
  - 재시도 로직 (최대 3회, 지수 백오프)
  - 모든 재시도 실패 시 해당 구독 건너뜀
- **출력**:
  - 로그에 재시도 실패 기록
  - 해당 사용자에게 수동 연락 필요 (고객센터)
  - 다음날 Cron에서 다시 시도 (결제일이 아직 유효한 경우)

#### Case 8.4.4: 빌링키 삭제 API 실패
- **처리**:
  - 구독 해지 처리는 완료 (DB 업데이트)
  - 빌링키 삭제만 실패
  - 로그에 에러 기록
- **출력**:
  - 사용자 구독은 해지됨
  - 빌링키는 토스페이먼츠에 남아 있음 (수동 삭제 필요)
  - 관리자에게 알림

#### Case 8.4.5: Supabase 연결 실패
- **처리**:
  - Cron 핸들러에서 DB 연결 에러 캐치
  - 500 Internal Server Error 응답
- **출력**:
  - Supabase Cron이 재시도 (설정에 따라)
  - 로그에 에러 기록
  - 관리자에게 긴급 알림 (결제 처리 중단)

#### Case 8.4.6: 동일 구독에 대해 Cron이 중복 실행
- **처리**:
  - DB 트랜잭션으로 동시성 제어
  - 또는 `current_period_end` 확인으로 중복 방지
  - 이미 갱신된 구독은 쿼리에서 제외됨
- **출력**:
  - 첫 번째 실행만 처리
  - 중복 결제 방지

#### Case 8.4.7: 취소 예약 상태 (`cancel_at_period_end = true`)인 구독
- **처리**:
  - 쿼리 조건에 `cancel_at_period_end = false` 포함
  - 해당 구독은 결제 대상에서 제외됨
  - 별도 로직으로 구독 만료 처리:
    - `status`: 'expired'
    - `plan`: 'free'
    - `remaining_tests`: 0
    - 토스페이먼츠 빌링키 삭제
    - `billing_key`: NULL
- **출력**:
  - 결제 시도 없음
  - 사용자 구독이 Free로 전환됨
  - (선택) 이메일: "Pro 구독이 종료되었습니다"

---

## 9. 구독 관리 페이지 조회

### 9.1 입력
- 사용자가 Global Nav 하단의 구독 정보 영역 클릭
- 또는 "Pro로 업그레이드" 안내에서 버튼 클릭
- `/subscription` 페이지 진입

### 9.2 처리
1. `/api/subscription/status` GET 요청
2. 서버 측 인증 확인
3. Supabase에서 현재 사용자의 구독 정보 조회
   - `user_id`로 필터링
   - 최신 구독 레코드 조회
4. 구독 데이터 반환:
   - 플랜 종류 (free/pro)
   - 상태 (active/expired)
   - 잔여 횟수, 최대 횟수
   - 다음 결제일 (Pro 플랜일 때)
   - 취소 예약 여부

### 9.3 출력
- **Free 플랜 사용자**:
  - 현재 구독 정보 카드:
    - 제목: "Free 플랜"
    - 잔여 횟수: X/3
    - 사용 모델: Gemini 2.5 Flash
    - 혜택 목록
  - 업그레이드 유도 카드:
    - 제목: "Pro 플랜으로 업그레이드하세요!"
    - Pro 혜택 강조
    - "지금 시작하기" 버튼 (토스페이먼츠 SDK 호출)
- **Pro 플랜 사용자 (정상 구독)**:
  - 현재 구독 정보 카드:
    - 제목: "Pro 플랜"
    - 잔여 횟수: X/10
    - 다음 결제일: YYYY년 MM월 DD일
    - 사용 모델: Gemini 2.5 Pro
    - 월 3,900원 자동 결제
    - "구독 취소" 버튼
- **Pro 플랜 사용자 (취소 예정)**:
  - 현재 구독 정보 카드:
    - 제목: "Pro 플랜 (취소 예정)"
    - 경고 배지: "취소 예정"
    - 안내 문구: "YYYY년 MM월 DD일에 구독이 종료됩니다"
    - 잔여 횟수: X/10 (종료일까지 사용 가능)
    - "취소 철회" 버튼

### 9.4 엣지케이스
#### Case 9.4.1: 구독 정보 조회 실패
- **처리**:
  - API 에러 발생
  - 클라이언트에서 에러 캐치
- **출력**:
  - "구독 정보를 불러올 수 없습니다" 에러 메시지
  - "다시 시도" 버튼

#### Case 9.4.2: 구독 데이터가 없음 (DB 누락)
- **처리**:
  - 서버에서 구독 레코드 조회 결과 없음
  - 404 Not Found 응답
- **출력**:
  - "구독 정보를 찾을 수 없습니다" 에러 메시지
  - "고객센터에 문의해주세요" 안내

#### Case 9.4.3: 만료된 Pro 구독 (`status = 'expired'`)
- **처리**:
  - 서버에서 만료 상태 감지
  - Free 플랜으로 표시
- **출력**:
  - Free 플랜 UI 표시
  - "이전에 Pro 구독을 이용하셨습니다. 다시 시작하시겠어요?" 안내
  - "Pro 시작하기" 버튼

---

## 10. 사용자 계정 삭제

### 10.1 입력
- 사용자가 Clerk 프로필 관리 페이지에서 "계정 삭제" 선택
- Clerk 확인 모달에서 삭제 확인

### 10.2 처리
1. Clerk가 계정 삭제 처리
2. Clerk Webhook이 `user.deleted` 이벤트를 Next.js API로 전송
3. Next.js API (`/api/auth/webhook`)가 Webhook 서명 검증
4. Supabase에서 사용자 관련 데이터 처리:
   - Pro 구독 중인 경우:
     - 토스페이먼츠 빌링키 삭제 API 호출
     - `subscriptions` 테이블 레코드 삭제 또는 `status = 'deleted'` 업데이트
   - `tests` 테이블의 사용자 검사 내역 삭제 또는 익명화
   - `payments` 테이블의 결제 내역 보관 (법적 요구사항)
   - `users` 테이블의 사용자 레코드 삭제 또는 `deleted_at` 마킹
5. (선택) 사용자에게 계정 삭제 확인 이메일 발송

### 10.3 출력
- Clerk 로그인 세션 종료
- 랜딩 페이지로 리다이렉트
- "계정이 삭제되었습니다" 메시지 (선택)

### 10.4 엣지케이스
#### Case 10.4.1: Pro 구독 중 계정 삭제
- **처리**:
  - Webhook 핸들러에서 구독 상태 확인
  - 토스페이먼츠 빌링키 삭제
  - 환불 없음 (정책)
- **출력**:
  - 정상적으로 계정 삭제
  - 남은 구독 기간에 대한 환불 없음

#### Case 10.4.2: 빌링키 삭제 실패
- **처리**:
  - 로그에 에러 기록
  - 관리자에게 알림 (수동 처리 필요)
  - 사용자 계정은 삭제 진행
- **출력**:
  - 사용자 측에서는 정상 삭제로 보임
  - 빌링키는 토스페이먼츠에 남아 있음 (수동 삭제 필요)

#### Case 10.4.3: Webhook 전송 실패
- **처리**:
  - Clerk가 자동 재시도
  - 재시도 실패 시 Supabase에 사용자 데이터 남음
- **출력**:
  - Clerk 계정은 삭제됨
  - Supabase에 고아(orphan) 데이터 발생
  - (해결책) 정기적으로 고아 데이터 정리 스크립트 실행

---

## 11. 검사 내역 영구 보관 및 조회

### 11.1 입력
- 사용자가 로그인 후 언제든지 대시보드 접근
- 오래된 검사 내역 조회 시도 (예: 1년 전)

### 11.2 처리
1. `/api/test/list` GET 요청
2. Supabase에서 사용자의 모든 검사 내역 조회 (삭제되지 않은 레코드)
3. 생성일 기준 정렬 (최신순 또는 오래된 순)
4. 페이지네이션 적용 (선택)

### 11.3 출력
- 모든 과거 검사 내역 표시 (제한 없음)
- 각 검사 카드 클릭 시 분석 상세보기로 이동
- 검사 일시 표시 (예: "2024년 1월 15일")

### 11.4 엣지케이스
#### Case 11.4.1: 검사 내역이 매우 많을 때 (수백 건)
- **처리**:
  - 페이지네이션 또는 무한 스크롤 구현
  - 초기 로드는 최근 20-50건만
- **출력**:
  - 스크롤 시 추가 로드
  - 로딩 스피너 표시

#### Case 11.4.2: 오래된 검사 결과의 마크다운 형식 변경
- **처리**:
  - 마크다운 파서가 유연하게 처리
  - 형식 오류 시 플레인 텍스트로 폴백
- **출력**:
  - 가능한 한 정상 렌더링
  - 형식 오류 시 원본 텍스트 표시

---

## 12. 랜딩 페이지 탐색

### 12.1 입력
- 사용자가 브라우저에서 서비스 URL 접속
- `/` 페이지 로드
- (선택) 헤더 메뉴의 앵커 링크 클릭 (홈, 서비스, 가격, FAQ)
- (선택) "무료 시작하기", "자세히 알아보기", "Pro 시작하기" 버튼 클릭

### 12.2 처리
1. 랜딩 페이지 렌더링:
   - 히어로 섹션
   - 서비스 소개 섹션
   - 요금제 섹션
   - FAQ 섹션
2. 앵커 링크 클릭 시:
   - 부드러운 스크롤로 해당 섹션 이동
3. "무료 시작하기" / "시작하기" 클릭 시:
   - Clerk 로그인 모달 표시
4. "Pro 시작하기" 클릭 시:
   - 인증 여부 확인
   - 인증된 경우: `/subscription` 페이지로 이동
   - 미인증된 경우: Clerk 로그인 모달 표시 → 로그인 후 `/subscription`으로 리다이렉트
5. "자세히 알아보기" 클릭 시:
   - 서비스 섹션으로 스크롤

### 12.3 출력
- 깔끔한 랜딩 페이지 UI
- 헤더: 로고, 메뉴, "시작하기" 버튼
- 히어로 섹션: 제목, 부제목, CTA 버튼, 대자연 이미지 (랜덤)
- 서비스 섹션: 3개 카드 (AI 분석, 합리적 가격, 영구 보관)
- 요금제 섹션: Free/Pro 카드
- FAQ 섹션: 아코디언 6개 (클릭 시 펼침/접힘)

### 12.4 엣지케이스
#### Case 12.4.1: 이미 로그인된 사용자가 랜딩 페이지 접속
- **처리**:
  - Clerk 세션 확인
  - 로그인 상태 감지
- **출력**:
  - 헤더 "시작하기" 버튼을 "대시보드로 이동" 버튼으로 변경
  - 또는 자동으로 `/dashboard`로 리다이렉트 (선택)

#### Case 12.4.2: 이미지 로드 실패 (Unsplash API 오류)
- **처리**:
  - 이미지 로드 에러 캐치
  - 폴백 이미지 표시
- **출력**:
  - 기본 대자연 이미지 (로컬 저장) 표시
  - 사용자 경험 유지

#### Case 12.4.3: FAQ 아코디언 클릭
- **처리**:
  - 클릭한 아코디언만 펼침
  - 다른 아코디언은 접힌 상태 유지 (또는 자동 닫힘)
- **출력**:
  - 삼각형 아이콘 회전 (▼ → ▲)
  - 답변 텍스트 슬라이드 다운 애니메이션

#### Case 12.4.4: "Pro 시작하기" 클릭 (미인증 상태)
- **처리**:
  - Clerk 로그인 모달 표시
  - 로그인 성공 후 리다이렉트 URL을 `/subscription`으로 설정
- **출력**:
  - 로그인 완료 후 구독 관리 페이지로 이동
  - Pro 구독 플로우 시작

---

## 13. Global Navigation 실시간 업데이트

### 13.1 입력
- 사용자가 다음 액션 수행 시:
  - 새 검사 완료
  - Pro 구독 시작
  - 구독 취소
  - 정기결제 갱신

### 13.2 처리
1. 각 액션 완료 후 서버에서 업데이트된 구독 정보 반환
2. 클라이언트가 Global Nav 컴포넌트의 상태 업데이트
3. React Context 또는 상태 관리 라이브러리 활용 (예: Zustand, Redux)

### 13.3 출력
- Global Nav 하단 정보 실시간 업데이트:
  - 이메일: 변경 없음
  - 잔여 횟수: 즉시 반영 (예: 3/3 → 2/3 → 10/10)
  - 구독: 플랜 변경 즉시 반영 (Free ↔ Pro)

### 13.4 엣지케이스
#### Case 13.4.1: 구독 정보 업데이트 실패 (네트워크 오류)
- **처리**:
  - 클라이언트에서 에러 캐치
  - 페이지 새로고침 안내
- **출력**:
  - "정보 업데이트에 실패했습니다. 페이지를 새로고침해주세요" 메시지

#### Case 13.4.2: 여러 탭에서 동시 사용
- **처리**:
  - 각 탭이 독립적으로 API 호출
  - 페이지 전환 시 최신 정보 조회
- **출력**:
  - 탭 간 정보 불일치 가능 (단기적)
  - 페이지 새로고침 시 동기화됨

---

## 14. 검사 횟수 제한 및 업그레이드 유도

### 14.1 입력
- Free 플랜 사용자가 3회 검사 완료 후 4번째 검사 시도
- 또는 Pro 플랜 사용자가 10회 검사 완료 후 11번째 검사 시도

### 14.2 처리
1. `/new-test` 페이지에서 "검사 시작" 버튼 클릭
2. `/api/test/create` 요청 전 클라이언트에서 잔여 횟수 확인 (선택)
3. 서버에서 잔여 횟수 확인 (`remaining_tests = 0`)
4. API가 403 Forbidden 응답 + 에러 메시지 반환

### 14.3 출력
- **Free 플랜 (3회 소진)**:
  - 에러 모달 표시:
    - 제목: "무료 검사 횟수를 모두 사용했습니다"
    - 내용: "Pro 플랜으로 업그레이드하면 월 10회 고품질 검사를 이용하실 수 있습니다"
    - "Pro로 업그레이드" 버튼 (Primary) → `/subscription` 페이지
    - "나중에" 버튼 (Secondary) → 모달 닫기
- **Pro 플랜 (10회 소진)**:
  - 에러 모달 표시:
    - 제목: "이번 달 검사 횟수를 모두 사용했습니다"
    - 내용: "다음 결제일(YYYY-MM-DD)에 횟수가 초기화됩니다"
    - "확인" 버튼 → 모달 닫기

### 14.4 엣지케이스
#### Case 14.4.1: 클라이언트와 서버의 잔여 횟수 불일치
- **처리**:
  - 클라이언트가 캐시된 정보로 버튼 활성화
  - 서버에서 실제 0회 감지
- **출력**:
  - 서버 응답 기준으로 에러 처리
  - 클라이언트 상태 동기화

#### Case 14.4.2: 동시에 여러 검사 시도 (Race Condition)
- **처리**:
  - DB 트랜잭션으로 동시성 제어
  - 첫 번째 요청만 성공
- **출력**:
  - 이후 요청은 "잔여 횟수 부족" 에러

---

## 15. 에러 처리 및 사용자 피드백

### 15.1 입력
- 사용자 액션 중 다양한 에러 발생 가능:
  - 네트워크 오류
  - 서버 에러 (5xx)
  - 인증 실패 (401)
  - 권한 없음 (403)
  - 리소스 없음 (404)
  - 중복 요청 (409)

### 15.2 처리
1. 클라이언트에서 모든 API 요청에 에러 핸들링 추가
2. HTTP 상태 코드별 분기 처리
3. 사용자 친화적인 에러 메시지 생성
4. 로그에 상세 에러 정보 기록

### 15.3 출력
- **네트워크 오류**:
  - "인터넷 연결을 확인해주세요" 메시지
  - 재시도 버튼
- **401 Unauthorized**:
  - 자동으로 로그인 페이지로 리다이렉트
- **403 Forbidden**:
  - "접근 권한이 없습니다" 메시지
  - 홈으로 돌아가기 버튼
- **404 Not Found**:
  - "요청하신 페이지를 찾을 수 없습니다" 에러 페이지
- **500 Internal Server Error**:
  - "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
  - 고객센터 연락처

### 15.4 엣지케이스
#### Case 15.4.1: 연속된 에러 발생
- **처리**:
  - 에러 횟수 추적
  - 3회 이상 연속 실패 시 특별 처리
- **출력**:
  - "계속 문제가 발생합니다. 고객센터에 문의해주세요" 메시지
  - 고객센터 이메일/전화 표시

---

## 요약

이 문서는 Saju피아 서비스의 15가지 핵심 사용자 플로우를 다룹니다:

1. 신규 사용자 회원가입 및 Free 플랜 부여
2. 새 검사 생성 및 AI 분석 실행
3. 대시보드 검사 내역 조회
4. 분석 상세보기
5. Pro 구독 시작
6. 구독 취소
7. 구독 취소 철회
8. 정기결제 자동 실행 (Supabase Cron)
9. 구독 관리 페이지 조회
10. 사용자 계정 삭제
11. 검사 내역 영구 보관 및 조회
12. 랜딩 페이지 탐색
13. Global Navigation 실시간 업데이트
14. 검사 횟수 제한 및 업그레이드 유도
15. 에러 처리 및 사용자 피드백

각 플로우는 입력-처리-출력 구조로 작성되었으며, 발생 가능한 엣지케이스를 포함합니다.

---

**문서 작성 완료**
**작성일**: 2025-12-12
**버전**: 1.0

