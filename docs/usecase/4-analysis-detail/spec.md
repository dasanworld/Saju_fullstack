# 유스케이스 명세: 분석 상세보기

**기능 번호**: 4
**기능명**: 분석 상세보기
**관련 페이지**: `/analysis/[id]`
**우선순위**: P0 (필수)
**작성일**: 2025-12-12
**버전**: 1.0

---

## 1. 개요

### 1.1 목적
사용자가 과거에 수행한 사주 팔자 검사의 상세 분석 결과를 조회하고 확인할 수 있는 기능을 제공합니다.

### 1.2 범위
- 검사 대상자 정보 표시
- AI 분석 결과를 마크다운 형식으로 렌더링
- 사주 카페 분위기의 UI 디자인
- 검사 내역으로의 네비게이션 제공

### 1.3 사용자 대상
- 로그인한 모든 사용자 (Free 및 Pro 플랜)
- 자신의 검사 내역만 조회 가능

---

## 2. 사용자 플로우

### 2.1 기본 플로우

```
[대시보드]
  → 검사 카드 클릭
  → [분석 상세보기 페이지 로드]
  → 검사 정보 표시
  → AI 분석 결과 렌더링
  → 하단 액션 버튼 표시
```

### 2.2 진입 경로
1. 대시보드에서 검사 카드 클릭
2. 새 검사 완료 후 자동 리다이렉트
3. 직접 URL 접근 (본인 검사만)

---

## 3. 기능 요구사항

### 3.1 입력

#### 3.1.1 URL 파라미터
- `id` (UUID): 조회할 검사의 고유 ID

#### 3.1.2 사용자 인증
- Clerk 세션을 통한 로그인 상태 확인
- 검사 소유권 검증 필요

### 3.2 처리

#### 3.2.1 데이터 조회
1. URL에서 검사 ID 추출
2. `/api/test/[id]` GET 요청
3. 서버에서 인증 확인 (Clerk 세션)
4. Supabase에서 검사 데이터 조회
   - `id`로 검색
   - `user_id` 일치 확인 (권한 검증)
5. 검사 데이터 반환

#### 3.2.2 데이터 구조
```typescript
interface TestDetail {
  id: string;
  name: string;
  birth_date: string; // YYYY-MM-DD
  birth_time: string | null; // HH:MM 또는 null
  gender: 'male' | 'female';
  analysis_result: string; // 마크다운 형식
  created_at: string; // ISO 8601
  user: {
    plan: 'free' | 'pro';
  };
}
```

#### 3.2.3 마크다운 렌더링
1. `analysis_result` 필드의 마크다운 텍스트 추출
2. 클라이언트에서 마크다운 → HTML 변환
3. 라이브러리: `react-markdown` + `remark-gfm`
4. 스타일링 적용

### 3.3 출력

#### 3.3.1 UI 구성

**1) 페이지 레이아웃**
- 좌측 Global Navigation (공통)
- 메인 컨텐츠 영역 (사주 카페 분위기)

**2) 상단 정보 카드**
```
┌─────────────────────────────────────────────┐
│  🌙 사주 팔자 분석 결과                      │
├─────────────────────────────────────────────┤
│  이름: 홍길동                                │
│  생년월일: 1990년 5월 15일                   │
│  출생시간: 오전 10시 30분 (또는 "시간 미상") │
│  성별: 남성                                  │
│  분석일: 2025년 12월 12일 14:30             │
│  사용 모델: Gemini 2.5 Pro                   │
└─────────────────────────────────────────────┘
```

**3) 분석 결과 섹션**
- 마크다운 렌더링 결과
- 섹션별 구분:
  - 천간·지지 계산
  - 오행 분석 (목, 화, 토, 금, 수)
  - 대운·세운 해석
  - 성격/재운/건강운/연애운

**4) 하단 액션 버튼**
- "대시보드로 돌아가기" (Secondary 버튼)
- "새 검사 시작" (Primary 버튼)

#### 3.3.2 디자인 가이드

**색상 테마: 사주 카페 분위기**
- 배경: 따뜻한 베이지/크림 톤 (#F5F3EE)
- 카드: 밝은 아이보리 (#FFFEF9)
- 강조: 브라운/골드 톤 (#8B6F47)
- 텍스트: 다크 브라운 (#2C2416)

**아이콘**
- 별, 달, 태극, 전통 문양
- 섹션별 구분 아이콘

**타이포그래피**
- 제목: 세리프 폰트 또는 한글 전통 서체
- 본문: 고딕체 (가독성 우선)

---

## 4. 엣지 케이스 및 예외 처리

### 4.1 존재하지 않는 검사 ID

**상황**: 사용자가 잘못된 ID로 접근
```
/analysis/00000000-0000-0000-0000-000000000000
```

**처리**:
1. 서버에서 검사 데이터 조회 결과 없음
2. 404 Not Found 응답

**출력**:
```
┌─────────────────────────────────┐
│  ⚠️  검사를 찾을 수 없습니다     │
│                                 │
│  요청하신 검사 내역이 없거나     │
│  삭제되었을 수 있습니다.         │
│                                 │
│  [대시보드로 돌아가기]           │
└─────────────────────────────────┘
```

### 4.2 다른 사용자의 검사 접근 시도

**상황**: 사용자 A가 사용자 B의 검사 ID로 접근

**처리**:
1. 서버에서 `user_id` 불일치 감지
2. 403 Forbidden 응답

**출력**:
```
┌─────────────────────────────────┐
│  🚫 접근 권한이 없습니다         │
│                                 │
│  본인의 검사 내역만 조회할 수    │
│  있습니다.                      │
│                                 │
│  [대시보드로 돌아가기]           │
└─────────────────────────────────┘
```

### 4.3 AI 분석 결과가 NULL

**상황**: 검사 생성 중 Gemini API 오류로 `analysis_result = null`

**처리**:
1. 서버에서 `analysis_result` 필드가 null 감지
2. 200 OK 응답이지만 특수 상태 플래그 반환

**출력**:
```
┌─────────────────────────────────┐
│  ⏳ 분석 결과 준비 중            │
│                                 │
│  분석 결과가 아직 준비되지       │
│  않았습니다.                    │
│                                 │
│  잠시 후 다시 시도해주세요.      │
│                                 │
│  [대시보드로 돌아가기]           │
└─────────────────────────────────┘
```

### 4.4 마크다운 형식 오류

**상황**: Gemini 응답 형식이 비정상적인 경우

**처리**:
1. `react-markdown` 파서가 에러 방지 모드로 작동
2. 변환 가능한 부분만 렌더링
3. 불가능한 부분은 플레인 텍스트로 표시

**출력**:
- 분석 결과를 가능한 한 렌더링
- 상단에 경고 메시지 표시:
```
⚠️ 일부 내용이 올바르게 표시되지 않을 수 있습니다.
```

### 4.5 비인증 사용자 접근

**상황**: 로그인하지 않은 사용자가 URL로 직접 접근

**처리**:
1. Next.js Middleware에서 인증 상태 확인
2. 미인증 감지

**출력**:
- Clerk 로그인 페이지로 자동 리다이렉트
- 로그인 완료 후 원래 URL로 복귀

### 4.6 출생시간 미상

**상황**: 검사 시 "출생시간 모름" 체크한 경우

**처리**:
- `birth_time` 필드가 null

**출력**:
```
출생시간: 시간 미상
```

### 4.7 네트워크 오류

**상황**: API 요청 실패 (서버 다운, 연결 끊김)

**처리**:
1. 클라이언트에서 에러 캐치
2. 재시도 로직 (최대 3회)

**출력**:
```
┌─────────────────────────────────┐
│  ❌ 데이터를 불러올 수 없습니다  │
│                                 │
│  인터넷 연결을 확인해주세요.     │
│                                 │
│  [다시 시도]  [대시보드로]       │
└─────────────────────────────────┘
```

---

## 5. API 명세

### 5.1 검사 상세 조회 API

**엔드포인트**: `GET /api/test/[id]`

**요청**:
```http
GET /api/test/550e8400-e29b-41d4-a716-446655440000 HTTP/1.1
Authorization: Bearer <clerk_session_token>
```

**응답 (성공)**:
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "홍길동",
    "birth_date": "1990-05-15",
    "birth_time": "10:30:00",
    "gender": "male",
    "analysis_result": "# 사주팔자 분석 결과\n\n## 천간·지지\n...",
    "created_at": "2025-12-12T14:30:00Z",
    "plan": "pro"
  }
}
```

**응답 (실패 - 404)**:
```json
{
  "success": false,
  "error": "TEST_NOT_FOUND",
  "message": "검사를 찾을 수 없습니다"
}
```

**응답 (실패 - 403)**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "접근 권한이 없습니다"
}
```

**응답 (실패 - 401)**:
```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "로그인이 필요합니다"
}
```

---

## 6. 데이터베이스 쿼리

### 6.1 검사 상세 조회

```sql
SELECT
  t.id,
  t.name,
  t.birth_date,
  t.birth_time,
  t.gender,
  t.analysis_result,
  t.created_at,
  s.plan
FROM tests t
JOIN subscriptions s ON t.user_id = s.user_id
WHERE t.id = $1
  AND t.user_id = $2; -- 권한 검증
```

**파라미터**:
- `$1`: 검사 ID (UUID)
- `$2`: 현재 사용자 ID (Clerk에서 조회)

---

## 7. 마크다운 렌더링 상세

### 7.1 사용 라이브러리

```typescript
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
```

### 7.2 렌더링 예시

**마크다운 입력**:
```markdown
# 사주팔자 분석 결과

## 천간·지지
- 년주: 甲子 (갑자)
- 월주: 乙丑 (을축)
- 일주: 丙寅 (병인)
- 시주: 丁卯 (정묘)

## 오행 분석
**목(木)**: 강함 - 성장과 확장의 기운이 뚜렷합니다.
**화(火)**: 중간 - 열정과 활력이 적절히 조화롭습니다.

> 전반적으로 균형 잡힌 오행 배치를 보입니다.
```

**HTML 출력 (스타일 적용 전)**:
```html
<h1>사주팔자 분석 결과</h1>

<h2>천간·지지</h2>
<ul>
  <li>년주: 甲子 (갑자)</li>
  <li>월주: 乙丑 (을축)</li>
  <li>일주: 丙寅 (병인)</li>
  <li>시주: 丁卯 (정묘)</li>
</ul>

<h2>오행 분석</h2>
<p><strong>목(木)</strong>: 강함 - 성장과 확장의 기운이 뚜렷합니다.</p>
<p><strong>화(火)</strong>: 중간 - 열정과 활력이 적절히 조화롭습니다.</p>

<blockquote>
  <p>전반적으로 균형 잡힌 오행 배치를 보입니다.</p>
</blockquote>
```

### 7.3 스타일 가이드

```css
.analysis-content {
  /* 제목 */
  h1 {
    font-size: 2rem;
    color: #2C2416;
    margin-bottom: 1.5rem;
    font-weight: 700;
  }

  h2 {
    font-size: 1.5rem;
    color: #8B6F47;
    margin-top: 2rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #E5DCC5;
    padding-bottom: 0.5rem;
  }

  /* 리스트 */
  ul, ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }

  li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  /* 강조 */
  strong {
    color: #8B6F47;
    font-weight: 600;
  }

  /* 인용 */
  blockquote {
    border-left: 4px solid #8B6F47;
    padding-left: 1rem;
    margin: 1rem 0;
    background: #FFFEF9;
    font-style: italic;
    color: #5A4A33;
  }

  /* 단락 */
  p {
    margin-bottom: 1rem;
    line-height: 1.7;
    color: #2C2416;
  }
}
```

---

## 8. UI 컴포넌트 구조

### 8.1 페이지 컴포넌트 계층

```
AnalysisDetailPage
├─ GlobalNavigation (공통)
└─ AnalysisDetailContent
    ├─ AnalysisHeader
    │   ├─ Icon (전통 문양)
    │   └─ Title
    ├─ InfoCard
    │   ├─ NameField
    │   ├─ BirthDateField
    │   ├─ BirthTimeField
    │   ├─ GenderField
    │   ├─ CreatedAtField
    │   └─ ModelBadge
    ├─ AnalysisResult
    │   └─ ReactMarkdown
    └─ ActionButtons
        ├─ BackButton (대시보드로)
        └─ NewTestButton (새 검사)
```

### 8.2 반응형 디자인

**모바일 (< 768px)**:
- 싱글 컬럼 레이아웃
- 정보 카드: 세로 방향
- 버튼: 풀 너비

**태블릿 (768px - 1024px)**:
- 여백 증가
- 정보 카드: 2컬럼 그리드

**데스크탑 (> 1024px)**:
- 최대 너비: 800px (가독성)
- 중앙 정렬
- 정보 카드: 3컬럼 그리드

---

## 9. 성능 고려사항

### 9.1 로딩 최적화

1. **스켈레톤 UI**
   - 데이터 로드 전 스켈레톤 표시
   - 정보 카드 및 분석 결과 영역

2. **이미지 최적화**
   - 아이콘: SVG 사용
   - 배경 이미지: WebP 포맷

3. **코드 스플리팅**
   - `react-markdown` 동적 임포트
   ```typescript
   const ReactMarkdown = dynamic(() => import('react-markdown'));
   ```

### 9.2 캐싱

- 검사 데이터는 변경되지 않으므로 브라우저 캐싱 활용
- Cache-Control: `public, max-age=31536000`

---

## 10. 접근성 (Accessibility)

### 10.1 ARIA 레이블

```html
<main aria-label="사주 팔자 분석 상세">
  <section aria-labelledby="info-heading">
    <h2 id="info-heading">검사 정보</h2>
    ...
  </section>

  <section aria-labelledby="result-heading">
    <h2 id="result-heading">분석 결과</h2>
    ...
  </section>
</main>
```

### 10.2 키보드 네비게이션

- Tab 키로 모든 인터랙티브 요소 접근 가능
- 버튼: Enter 또는 Space로 활성화

### 10.3 색상 대비

- WCAG AA 기준 준수 (최소 4.5:1)
- 텍스트: #2C2416 vs 배경: #F5F3EE (대비 8.2:1)

---

## 11. 테스트 시나리오

### 11.1 정상 플로우

```
[Given] 사용자가 로그인하고 과거 검사 내역이 있음
[When] 대시보드에서 검사 카드를 클릭
[Then]
  - 분석 상세보기 페이지로 이동
  - 검사 정보가 올바르게 표시됨
  - AI 분석 결과가 마크다운으로 렌더링됨
  - 하단 버튼이 표시됨
```

### 11.2 권한 검증

```
[Given] 사용자 A가 로그인함
[When] 사용자 B의 검사 ID로 접근 시도
[Then]
  - 403 에러 페이지 표시
  - "접근 권한이 없습니다" 메시지
  - 대시보드로 돌아가기 버튼 표시
```

### 11.3 존재하지 않는 검사

```
[Given] 사용자가 로그인함
[When] 잘못된 검사 ID로 접근
[Then]
  - 404 에러 페이지 표시
  - "검사를 찾을 수 없습니다" 메시지
```

### 11.4 출생시간 미상

```
[Given] 검사 시 "출생시간 모름" 체크함
[When] 해당 검사 상세보기 접근
[Then]
  - 출생시간 필드에 "시간 미상" 표시
```

### 11.5 마크다운 렌더링

```
[Given] AI 분석 결과가 마크다운 형식
[When] 분석 상세보기 접근
[Then]
  - 제목(H1, H2)이 스타일 적용됨
  - 리스트가 올바르게 렌더링됨
  - 강조(bold)가 색상과 함께 표시됨
  - 인용구가 좌측 보더와 함께 표시됨
```

---

## 12. 후속 작업 (향후 개선)

### 12.1 공유 기능
- 검사 결과 PDF 다운로드
- 소셜 미디어 공유 (이미지 생성)

### 12.2 인쇄 최적화
- `@media print` 스타일 추가
- 불필요한 요소 숨김 (네비게이션, 버튼)

### 12.3 즐겨찾기
- 중요한 검사 북마크 기능

### 12.4 비교 기능
- 여러 검사 결과 비교 뷰

---

## 13. 체크리스트

### 개발 전
- [ ] API 엔드포인트 설계 검토
- [ ] 데이터베이스 쿼리 최적화 확인
- [ ] RLS 정책 검증 (본인만 조회)
- [ ] 디자인 시안 확정

### 개발 중
- [ ] API 구현 및 테스트
- [ ] 마크다운 렌더링 검증
- [ ] 에러 케이스 처리
- [ ] 반응형 디자인 구현
- [ ] 접근성 검토

### 개발 후
- [ ] 권한 테스트 (다른 사용자 검사 접근)
- [ ] 성능 테스트 (로딩 시간 3초 이내)
- [ ] 브라우저 호환성 테스트
- [ ] 스크린 리더 테스트
- [ ] 모바일 디바이스 테스트

---

## 14. 관련 문서

- `/docs/requirement.md` - 전체 요구사항
- `/docs/prd.md` - 상세 제품 명세
- `/docs/userflow.md` - 사용자 플로우 (4번 항목)
- `/docs/database.md` - 데이터베이스 스키마
- `/docs/external/fullstackIntegration.md` - 외부 서비스 연동

---

**문서 버전**: 1.0
**작성일**: 2025-12-12
**작성자**: Product Team
**검토자**: -
**승인자**: -
