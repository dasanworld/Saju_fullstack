# 유스케이스 14: 검사 횟수 제한 및 업그레이드 유도

**프로젝트**: Saju피아 - AI 기반 사주팔자 분석 SaaS
**작성일**: 2025-12-12
**버전**: 1.0

---

## 1. 개요

### 1.1 목적
사용자가 플랜별 검사 횟수 제한에 도달했을 때, 명확한 안내와 함께 업그레이드를 유도하여 서비스 수익화와 사용자 경험을 균형있게 유지합니다.

### 1.2 범위
- Free 플랜: 최초 3회 검사 제한
- Pro 플랜: 월 10회 검사 제한
- 횟수 소진 시 사용자 안내 및 업그레이드 유도
- 다음 결제일 횟수 초기화 안내

### 1.3 관련 페이지
- `/new-test` (새 검사)
- `/subscription` (구독 관리)

---

## 2. 사용자 시나리오

### 2.1 Free 플랜 사용자 (3회 소진)

#### 시나리오 A: 검사 횟수 소진 후 추가 검사 시도
**전제 조건**: Free 플랜 사용자가 이미 3회 검사 완료

1. 사용자가 Global Nav에서 "새 검사" 클릭
2. `/new-test` 페이지 진입
3. 폼 필드 입력 (이름, 생년월일, 출생시간, 성별)
4. "검사 시작" 버튼 클릭 시도
5. 시스템이 잔여 횟수 확인 (0/3)
6. 에러 모달 표시:
   - 제목: "무료 검사 횟수를 모두 사용했습니다"
   - 내용: "Pro 플랜으로 업그레이드하면 월 10회 고품질 검사를 이용하실 수 있습니다"
   - CTA: "Pro로 업그레이드" (Primary 버튼)
   - "나중에" (Secondary 버튼)
7. 사용자가 "Pro로 업그레이드" 클릭
8. `/subscription` 페이지로 이동
9. 토스페이먼츠 결제 플로우 시작

**기대 결과**:
- 검사가 실행되지 않음 (횟수 차감 없음)
- 명확한 업그레이드 안내
- 원클릭 업그레이드 경로 제공

---

### 2.2 Pro 플랜 사용자 (10회 소진)

#### 시나리오 B: 월 검사 횟수 소진 후 추가 검사 시도
**전제 조건**: Pro 플랜 사용자가 이번 달 10회 검사 완료

1. 사용자가 "새 검사" 페이지 진입
2. Global Nav 하단에 "잔여 횟수: 0/10" 표시 확인
3. 폼 입력 후 "검사 시작" 클릭
4. 시스템이 잔여 횟수 확인 (0/10)
5. 에러 모달 표시:
   - 제목: "이번 달 검사 횟수를 모두 사용했습니다"
   - 내용: "다음 결제일(YYYY년 MM월 DD일)에 횟수가 10회로 초기화됩니다"
   - CTA: "확인" (Primary 버튼)
6. 사용자가 "확인" 클릭
7. 모달 닫힘, 페이지 유지

**기대 결과**:
- 검사가 실행되지 않음
- 다음 결제일 안내로 기대감 형성
- 업그레이드 유도 없음 (이미 최상위 플랜)

---

### 2.3 사용 중 횟수 모니터링

#### 시나리오 C: 잔여 횟수 실시간 확인
**전제 조건**: 사용자가 로그인 상태

1. 모든 보호된 페이지에서 Global Nav 하단 확인 가능
2. 표시 내용:
   - 이메일: `user@example.com`
   - 잔여 횟수: `X/Y` (예: 2/3, 7/10)
   - 구독: `Free` 또는 `Pro`
3. 검사 완료 후 실시간 업데이트:
   - 3/3 → 2/3 → 1/3 → 0/3
   - 10/10 → 9/10 → ... → 0/10

**기대 결과**:
- 사용자가 언제든 잔여 횟수 파악 가능
- 횟수 소진 전 사전 인지

---

## 3. 기능 요구사항

### 3.1 횟수 검증 (서버 측)

#### FR-14.1: 검사 생성 전 잔여 횟수 확인
**설명**: `/api/test/create` 호출 시 서버에서 잔여 횟수를 확인하여 0일 경우 403 에러 반환

**Acceptance Criteria**:
- [ ] `remaining_tests = 0` 일 때 검사 생성 차단
- [ ] 403 Forbidden 에러 코드 반환
- [ ] 에러 응답에 플랜 정보 포함 (free/pro)
- [ ] 에러 응답에 다음 결제일 포함 (Pro 플랜만)
- [ ] 횟수 차감 없음 (트랜잭션 롤백)

**API 응답 예시**:
```json
{
  "error": "TESTS_LIMIT_REACHED",
  "message": "검사 횟수를 모두 사용했습니다",
  "plan": "free",
  "remaining_tests": 0,
  "max_tests": 3,
  "next_billing_date": null
}
```

```json
{
  "error": "TESTS_LIMIT_REACHED",
  "message": "이번 달 검사 횟수를 모두 사용했습니다",
  "plan": "pro",
  "remaining_tests": 0,
  "max_tests": 10,
  "next_billing_date": "2025-01-15"
}
```

---

### 3.2 UI/UX

#### FR-14.2: Free 플랜 횟수 소진 모달
**설명**: Free 플랜 사용자가 3회 소진 후 검사 시도 시 업그레이드 유도 모달 표시

**Acceptance Criteria**:
- [ ] 모달 제목: "무료 검사 횟수를 모두 사용했습니다"
- [ ] 설명 문구: "Pro 플랜으로 업그레이드하면 월 10회 고품질 검사를 이용하실 수 있습니다"
- [ ] Pro 혜택 표시:
  - 월 10회 검사
  - Gemini 2.5 Pro 모델 사용
  - 더 상세한 분석
  - 월 3,900원
- [ ] "Pro로 업그레이드" Primary 버튼 → `/subscription` 이동
- [ ] "나중에" Secondary 버튼 → 모달 닫기
- [ ] 모달 외부 클릭 시 닫기 불가 (명시적 선택 유도)

**디자인 가이드**:
- 모달 크기: 중간 (400px x 500px)
- 색상: Pro 강조 (Primary 컬러)
- 아이콘: 업그레이드 관련 (별, 화살표 위 등)

---

#### FR-14.3: Pro 플랜 횟수 소진 모달
**설명**: Pro 플랜 사용자가 10회 소진 후 검사 시도 시 다음 결제일 안내 모달 표시

**Acceptance Criteria**:
- [ ] 모달 제목: "이번 달 검사 횟수를 모두 사용했습니다"
- [ ] 설명 문구: "다음 결제일(YYYY년 MM월 DD일)에 횟수가 10회로 초기화됩니다"
- [ ] 추가 안내: "지속적인 이용 감사드립니다"
- [ ] "확인" Primary 버튼 → 모달 닫기
- [ ] 업그레이드 유도 없음

**디자인 가이드**:
- 모달 크기: 작음 (350px x 300px)
- 색상: 중립 (Gray)
- 아이콘: 정보 (i 아이콘)

---

#### FR-14.4: Global Nav 잔여 횟수 표시
**설명**: 모든 보호된 페이지에서 Global Nav 하단에 실시간 잔여 횟수 표시

**Acceptance Criteria**:
- [ ] 표시 형식: `잔여 횟수: X/Y` (예: 2/3, 7/10)
- [ ] Free 플랜: Y = 3
- [ ] Pro 플랜: Y = 10
- [ ] 검사 완료 후 실시간 업데이트
- [ ] 0/Y 상태일 때 경고 색상 (Red 또는 Orange)
- [ ] 클릭 시 `/subscription` 페이지로 이동 (선택)

**디자인 가이드**:
- 아이콘: 티켓 또는 카운터 관련
- 0/Y 상태: 빨강/주황 경고
- 1-3/Y 상태: 노랑 주의 (Free 플랜)
- 4+/Y 상태: 정상 (Green/Gray)

---

### 3.3 클라이언트 측 사전 검증 (선택)

#### FR-14.5: 검사 시작 버튼 비활성화
**설명**: 클라이언트에서 잔여 횟수를 확인하여 0일 경우 버튼 비활성화 및 안내 표시

**Acceptance Criteria**:
- [ ] 페이지 로드 시 구독 정보 조회 (`/api/subscription/status`)
- [ ] `remaining_tests = 0` 일 때 버튼 비활성화
- [ ] 버튼 위 또는 아래 안내 문구 표시:
  - Free: "검사 횟수를 모두 사용했습니다. Pro로 업그레이드하세요"
  - Pro: "이번 달 검사 횟수를 모두 사용했습니다. 다음 결제일에 초기화됩니다"
- [ ] 버튼 대신 "Pro로 업그레이드" 버튼 표시 (Free 플랜만)
- [ ] 서버 측 검증은 여전히 필수 (보안)

**주의사항**:
- 클라이언트 검증은 UX 개선용
- 서버 측 검증이 최종 권한

---

## 4. API 명세

### 4.1 검사 생성 API

#### POST `/api/test/create`

**Request Body**:
```json
{
  "name": "홍길동",
  "birth_date": "1990-01-15",
  "birth_time": "14:30",
  "gender": "male"
}
```

**Response (성공 - 200 OK)**:
```json
{
  "id": "uuid-xxx",
  "analysis_result": "마크다운 결과...",
  "remaining_tests": 2
}
```

**Response (횟수 소진 - 403 Forbidden)**:
```json
{
  "error": "TESTS_LIMIT_REACHED",
  "message": "검사 횟수를 모두 사용했습니다",
  "plan": "free",
  "remaining_tests": 0,
  "max_tests": 3,
  "next_billing_date": null
}
```

**Response (Pro 횟수 소진 - 403 Forbidden)**:
```json
{
  "error": "TESTS_LIMIT_REACHED",
  "message": "이번 달 검사 횟수를 모두 사용했습니다",
  "plan": "pro",
  "remaining_tests": 0,
  "max_tests": 10,
  "next_billing_date": "2025-01-15"
}
```

---

### 4.2 구독 정보 조회 API

#### GET `/api/subscription/status`

**Response (200 OK)**:
```json
{
  "plan": "free",
  "remaining_tests": 0,
  "max_tests": 3,
  "next_billing_date": null,
  "cancel_at_period_end": false
}
```

```json
{
  "plan": "pro",
  "remaining_tests": 3,
  "max_tests": 10,
  "next_billing_date": "2025-01-15",
  "cancel_at_period_end": false
}
```

---

## 5. 데이터베이스 쿼리

### 5.1 잔여 횟수 확인 쿼리
```sql
SELECT
  plan,
  remaining_tests
FROM subscriptions
WHERE user_id = $1;
```

**조건 검증 (애플리케이션 레벨)**:
```typescript
const MAX_TESTS = { free: 3, pro: 10 };

if (subscription.remaining_tests <= 0) {
  throw new Error('TESTS_LIMIT_REACHED');
}
```

---

### 5.2 횟수 차감 쿼리 (트랜잭션)
```sql
-- 1. 횟수 확인 및 차감
UPDATE subscriptions
SET remaining_tests = remaining_tests - 1
WHERE user_id = $1
  AND remaining_tests > 0
RETURNING remaining_tests;

-- 2. 검사 레코드 생성
INSERT INTO tests (user_id, name, birth_date, birth_time, gender)
VALUES ($1, $2, $3, $4, $5)
RETURNING id;

-- 3. AI 분석 후 결과 업데이트
UPDATE tests
SET analysis_result = $2
WHERE id = $1;
```

**트랜잭션 실패 시**:
- 모든 변경사항 롤백
- 횟수 차감 없음

---

## 6. 엣지케이스

### 6.1 동시 요청 (Race Condition)

**시나리오**: 잔여 횟수 1회일 때 사용자가 2개 검사를 동시 제출

**처리**:
- DB 트랜잭션으로 동시성 제어
- `UPDATE ... WHERE remaining_tests > 0` 조건으로 원자성 보장
- 첫 번째 요청만 성공, 두 번째 요청은 403 에러

**기대 결과**:
- 횟수 초과 방지
- 사용자에게 명확한 에러 메시지

---

### 6.2 클라이언트-서버 상태 불일치

**시나리오**: 클라이언트가 캐시된 정보로 버튼 활성화, 서버에서는 0회

**처리**:
- 서버 측 검증이 최종 권한
- 클라이언트 에러 발생 시 구독 정보 재조회
- 사용자에게 "정보를 업데이트합니다" 메시지 후 재시도

**기대 결과**:
- 서버 응답 기준으로 정확한 처리
- 클라이언트 상태 동기화

---

### 6.3 Free 플랜 사용자의 반복 업그레이드 시도

**시나리오**: 사용자가 "나중에" 클릭 후 다시 검사 시도

**처리**:
- 매번 동일한 모달 표시
- 사용자가 명시적으로 업그레이드 또는 포기 선택할 때까지 반복

**기대 결과**:
- 일관된 사용자 경험
- 명확한 업그레이드 경로 유지

---

### 6.4 Pro 플랜 결제일 임박

**시나리오**: 잔여 0/10 상태에서 다음 결제일이 내일인 경우

**처리**:
- 모달에 "내일 자동 갱신됩니다" 추가 안내
- 사용자의 기대감 및 리텐션 향상

**기대 결과**:
- 사용자가 구독 유지 동기 부여

---

### 6.5 구독 취소 예정 상태

**시나리오**: Pro 플랜이지만 `cancel_at_period_end = true` 상태

**처리**:
- 잔여 횟수 소진 시 일반 Pro 모달 표시
- 추가 안내: "구독 취소 예정이므로 다음 달에는 무료 플랜으로 전환됩니다"
- "취소 철회" 버튼 표시 (선택)

**기대 결과**:
- 사용자에게 재구독 기회 제공
- 리텐션 개선

---

## 7. 테스트 시나리오

### 7.1 Free 플랜 횟수 제한 테스트

**테스트 케이스 7.1.1: 3회 검사 후 4번째 시도**
1. Free 플랜 계정 생성
2. 3회 검사 완료 (잔여 3/3 → 0/3)
3. 4번째 검사 시도
4. 검증: 403 에러 반환, 모달 표시, 횟수 차감 없음

**테스트 케이스 7.1.2: 업그레이드 플로우**
1. 횟수 소진 모달에서 "Pro로 업그레이드" 클릭
2. 검증: `/subscription` 페이지 이동
3. Pro 구독 완료
4. 검증: 잔여 횟수 10/10으로 업데이트

---

### 7.2 Pro 플랜 횟수 제한 테스트

**테스트 케이스 7.2.1: 10회 검사 후 11번째 시도**
1. Pro 플랜 계정 생성
2. 10회 검사 완료 (잔여 10/10 → 0/10)
3. 11번째 검사 시도
4. 검증: 403 에러 반환, 다음 결제일 안내 모달 표시

**테스트 케이스 7.2.2: 정기결제 후 횟수 초기화**
1. Supabase Cron으로 정기결제 실행
2. 검증: 잔여 횟수 10/10으로 초기화
3. 새 검사 정상 진행

---

### 7.3 동시성 테스트

**테스트 케이스 7.3.1: 동시 검사 요청**
1. 잔여 1/3 상태
2. 2개 검사를 0.1초 간격으로 제출
3. 검증: 1개만 성공, 1개는 403 에러
4. 최종 잔여: 0/3

---

### 7.4 UI/UX 테스트

**테스트 케이스 7.4.1: Global Nav 실시간 업데이트**
1. 검사 완료 후 Global Nav 확인
2. 검증: 잔여 횟수 즉시 감소 (3/3 → 2/3)

**테스트 케이스 7.4.2: 모달 인터랙션**
1. Free 플랜 소진 모달에서 "나중에" 클릭
2. 검증: 모달 닫힘, 페이지 유지
3. 다시 검사 시도
4. 검증: 모달 재표시

---

## 8. 메트릭 및 모니터링

### 8.1 추적 지표

**비즈니스 메트릭**:
- Free 플랜 3회 소진율 (전체 Free 사용자 대비)
- Free → Pro 전환율 (횟수 소진 후)
- Pro 플랜 10회 소진율
- 평균 검사 횟수 (Free: 1-3회, Pro: 1-10회)

**기술 메트릭**:
- 403 에러 발생 빈도
- 동시 요청 충돌 빈도
- 횟수 검증 응답 시간 (< 100ms 목표)

---

### 8.2 로깅

**필수 로그**:
```json
{
  "event": "TEST_LIMIT_REACHED",
  "user_id": "uuid-xxx",
  "plan": "free",
  "remaining_tests": 0,
  "timestamp": "2025-01-15T10:30:00Z"
}
```

```json
{
  "event": "UPGRADE_CTA_SHOWN",
  "user_id": "uuid-xxx",
  "source": "test_limit_modal",
  "timestamp": "2025-01-15T10:30:05Z"
}
```

```json
{
  "event": "UPGRADE_CTA_CLICKED",
  "user_id": "uuid-xxx",
  "source": "test_limit_modal",
  "timestamp": "2025-01-15T10:30:10Z"
}
```

---

## 9. 구현 체크리스트

### 백엔드
- [ ] `/api/test/create`에 횟수 검증 로직 추가
- [ ] 403 에러 응답 형식 정의
- [ ] 트랜잭션으로 동시성 제어
- [ ] 에러 로깅 구현

### 프론트엔드
- [ ] Free 플랜 소진 모달 컴포넌트 구현
- [ ] Pro 플랜 소진 모달 컴포넌트 구현
- [ ] Global Nav 잔여 횟수 실시간 업데이트
- [ ] 403 에러 핸들링 및 모달 표시 로직
- [ ] 검사 시작 버튼 비활성화 로직 (선택)

### 테스트
- [ ] 유닛 테스트 (횟수 검증 로직)
- [ ] 통합 테스트 (전체 플로우)
- [ ] 동시성 테스트
- [ ] E2E 테스트 (모달 인터랙션)

### 배포
- [ ] 프로덕션 배포 전 스테이징 테스트
- [ ] 메트릭 대시보드 설정
- [ ] 알림 설정 (에러율 급증 시)

---

## 10. 참고 자료

### 내부 문서
- `/docs/requirement.md` - 구독 정책 (Free 3회, Pro 10회)
- `/docs/userflow.md` - 14번 플로우
- `/docs/database.md` - subscriptions.remaining_tests 필드

### 외부 참고
- [Stripe 사용량 제한 UI 예시](https://stripe.com/docs/billing/subscriptions/usage-based)
- [SaaS 업그레이드 모달 베스트 프랙티스](https://www.appcues.com/blog/upgrade-modal-examples)

---

**문서 버전**: 1.0
**작성일**: 2025-12-12
**작성자**: Claude Code
