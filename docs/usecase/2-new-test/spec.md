# 유스케이스: 새 검사 생성 및 AI 분석 실행

**기능 번호**: 2
**기능명**: 새 검사 생성 및 AI 분석 실행
**우선순위**: P0 (필수)
**작성일**: 2025-12-12

---

## 1. 개요

사용자가 사주 팔자 분석을 위한 개인 정보를 입력하고, Gemini AI를 통해 분석 결과를 생성하는 핵심 기능입니다. 사용자의 구독 플랜에 따라 사용되는 AI 모델이 다르며, 잔여 횟수가 차감됩니다.

---

## 2. 사용자 시나리오

### 2.1 기본 플로우
1. 사용자가 Global Nav에서 "새 검사" 메뉴를 클릭하거나 대시보드의 "새 검사 시작" 버튼 클릭
2. `/new-test` 페이지 진입
3. 사용자가 폼에 정보 입력:
   - 이름 (필수)
   - 생년월일 (필수, 캘린더 선택)
   - 출생시간 (선택, 시간 선택)
   - 출생시간 모름 체크박스 (선택)
   - 성별 (필수, 라디오 버튼)
4. "검사 시작" 버튼 클릭
5. AI 분석 진행 중 로딩 화면 표시
6. 분석 완료 후 분석 상세보기 페이지로 이동
7. 잔여 횟수 차감 반영

---

## 3. 입력

### 3.1 페이지 진입
- **트리거**: Global Nav "새 검사" 클릭 또는 대시보드 "새 검사 시작" 버튼 클릭
- **URL**: `/new-test`
- **인증 요구사항**: 로그인 필수

### 3.2 폼 필드

| 필드명 | 타입 | 필수 | 제약사항 | 기본값 | 비고 |
|--------|------|------|----------|--------|------|
| 이름 | 텍스트 | O | 1-50자 | 없음 | 검사 대상자 이름 |
| 생년월일 | Date | O | 오늘 이전 날짜 | 오늘 | 캘린더 선택 UI |
| 출생시간 | Time | X | HH:MM 형식 | 없음 | 12시간 형식 (AM/PM) |
| 출생시간 모름 | Checkbox | X | - | false | 체크 시 출생시간 비활성화 |
| 성별 | Radio | O | male/female | 없음 | 남성/여성 선택 |

---

## 4. 처리 과정

### 4.1 클라이언트 유효성 검증
1. 필수 필드 입력 확인 (이름, 생년월일, 성별)
2. 생년월일이 오늘 이전인지 확인
3. 출생시간 모름 체크 시 출생시간 필드 무시
4. 모든 검증 통과 시 "검사 시작" 버튼 활성화

### 4.2 API 호출
- **Endpoint**: `POST /api/test/create`
- **Request Body**:
```json
{
  "name": "홍길동",
  "birthDate": "1990-01-15",
  "birthTime": "14:30" | null,
  "gender": "male" | "female"
}
```

### 4.3 서버 처리 단계

#### 단계 1: 인증 확인
- Clerk 세션 검증
- 현재 로그인된 사용자 식별

#### 단계 2: 구독 정보 조회
- Supabase `subscriptions` 테이블 조회
- 사용자의 현재 플랜 확인 (free/pro)
- 잔여 횟수 확인 (`remaining_tests > 0`)

#### 단계 3: 잔여 횟수 검증
```sql
SELECT
  plan,
  remaining_tests
FROM subscriptions
WHERE user_id = $1
```

- 잔여 횟수가 0이면 403 Forbidden 응답
- 에러 메시지: "검사 횟수를 모두 사용했습니다"

#### 단계 4: 검사 레코드 생성
```sql
INSERT INTO tests (
  user_id,
  name,
  birth_date,
  birth_time,
  gender,
  analysis_result
) VALUES (
  $1, $2, $3, $4, $5, NULL
)
RETURNING id
```

#### 단계 5: AI 모델 선택
- Free 플랜: `gemini-2.5-flash`
- Pro 플랜: `gemini-2.5-pro`

#### 단계 6: Gemini API 호출

**시스템 프롬프트 생성**:
```typescript
`당신은 20년 경력의 전문 사주팔자 상담사입니다.

**입력 정보**:
- 성함: ${input.name}
- 생년월일: ${input.birthDate}
- 출생시간: ${input.birthTime || '미상'}
- 성별: ${input.gender === 'male' ? '남성' : '여성'}

**분석 요구사항**:
1. 천간(天干)과 지지(地支) 계산
2. 오행(五行) 분석 (목, 화, 토, 금, 수)
3. 대운(大運)과 세운(歲運) 해석
4. 전반적인 성격, 재운, 건강운, 연애운 분석

**출력 형식**: 마크다운

**금지 사항**:
- 의료·법률 조언
- 확정적 미래 예측
- 부정적·공격적 표현`
```

**API 설정**:
- 타임아웃: 30초
- 최대 재시도: 1회
- 응답 형식: 마크다운

#### 단계 7: AI 응답 처리
- 응답 수신 후 마크다운 형식 검증
- `tests` 테이블의 `analysis_result` 업데이트

```sql
UPDATE tests
SET analysis_result = $2
WHERE id = $1
```

#### 단계 8: 잔여 횟수 차감
```sql
UPDATE subscriptions
SET remaining_tests = remaining_tests - 1
WHERE user_id = $1
  AND remaining_tests > 0
RETURNING remaining_tests
```

#### 단계 9: 응답 반환
```json
{
  "success": true,
  "testId": "uuid",
  "remainingTests": 2
}
```

---

## 5. 출력

### 5.1 성공 시
- **로딩 UI**: "AI가 당신의 사주를 분석하고 있습니다..." (프로그레스 바 표시)
- **완료 후 리다이렉트**: `/analysis/[testId]`
- **토스트 메시지**: "분석이 완료되었습니다!"
- **Global Nav 업데이트**: 잔여 횟수 차감 반영 (예: 3/3 → 2/3)

### 5.2 실패 시
각 오류 상황별 UI 표시:

| 오류 유형 | HTTP 상태 | 메시지 | 액션 |
|-----------|----------|--------|------|
| 잔여 횟수 0 | 403 | "검사 횟수를 모두 사용했습니다" | "Pro로 업그레이드" 버튼 |
| 인증 실패 | 401 | 자동 로그인 페이지 이동 | - |
| 필수 필드 누락 | 400 | "필수 정보를 입력해주세요" | 폼 필드 하이라이트 |
| Gemini API 타임아웃 | 504 | "AI 서버가 응답하지 않습니다" | "다시 시도" 버튼 |
| Gemini API 오류 | 502 | "일시적으로 서비스 이용이 제한되었습니다" | "잠시 후 다시 시도" |
| DB 오류 | 500 | "일시적인 오류가 발생했습니다" | "다시 시도" 버튼 |

---

## 6. 엣지케이스

### Case 6.1: 잔여 횟수 0일 때 검사 시도
**상황**: Free 플랜 사용자가 3회를 모두 소진한 후 검사 시도

**처리**:
1. 서버에서 `remaining_tests = 0` 감지
2. 403 Forbidden 응답 반환

**출력**:
- 에러 모달 표시
- 제목: "무료 검사 횟수를 모두 사용했습니다"
- 내용: "Pro 플랜으로 업그레이드하면 월 10회 고품질 검사를 이용하실 수 있습니다"
- "Pro로 업그레이드" 버튼 (클릭 시 `/subscription` 이동)
- "나중에" 버튼 (모달 닫기)

### Case 6.2: Gemini API 응답 지연 (30초 초과)
**상황**: AI 서버 과부하로 응답 지연

**처리**:
1. 30초 타임아웃 설정
2. 타임아웃 발생 시 에러 캐치
3. 잔여 횟수 차감 롤백
4. `tests` 레코드 삭제 또는 `status='failed'` 마킹 (향후 확장)

**출력**:
- "AI 서버가 응답하지 않습니다. 잠시 후 다시 시도해주세요"
- "다시 시도" 버튼
- 잔여 횟수는 차감되지 않음

### Case 6.3: Gemini API 에러 응답 (429 Rate Limit)
**상황**: Gemini API 호출 한도 초과

**처리**:
1. 429 상태 코드 감지
2. 잔여 횟수 차감 롤백
3. 로그에 에러 기록

**출력**:
- "일시적으로 서비스 이용이 제한되었습니다. 잠시 후 다시 시도해주세요"
- 관리자에게 알림 (모니터링 필요)
- 대시보드로 리다이렉트

### Case 6.4: 출생시간 미입력
**상황**: 출생시간 모름 체크박스 선택 또는 시간 미입력

**처리**:
1. `birth_time = null`로 저장
2. Gemini 프롬프트에 "출생시간: 미상" 전달
3. AI가 출생시간 없이 분석 수행

**출력**:
- 정상적으로 분석 진행
- 분석 결과에 "출생시간 정보 없이 분석됨" 안내 포함 가능

### Case 6.5: 중복 요청 (버튼 연타)
**상황**: 사용자가 "검사 시작" 버튼을 빠르게 여러 번 클릭

**처리**:
1. 클라이언트: 첫 클릭 후 버튼 비활성화 (로딩 상태)
2. 서버: 동일 사용자의 1초 이내 중복 요청 감지
3. 두 번째 요청부터 거부

**출력**:
- "이미 진행 중인 검사가 있습니다" 메시지
- 첫 번째 요청만 처리

### Case 6.6: 생년월일 미래 날짜 입력
**상황**: 사용자가 오늘 이후 날짜를 입력 시도

**처리**:
1. 클라이언트: 캘린더 최대 날짜를 오늘로 제한
2. 서버: 날짜 검증 (`birth_date <= CURRENT_DATE`)
3. 위반 시 400 Bad Request 응답

**출력**:
- "생년월일은 오늘 이전이어야 합니다" 에러 메시지
- 날짜 필드 하이라이트

### Case 6.7: 비인증 사용자 접근
**상황**: 로그아웃 상태에서 `/new-test` URL 직접 접근

**처리**:
1. Next.js Middleware에서 인증 상태 확인
2. 미인증 사용자 감지 시 차단

**출력**:
- Clerk 로그인 페이지로 리다이렉트
- 로그인 완료 후 `/new-test`로 자동 리다이렉트

### Case 6.8: 동시 다중 검사 시도 (Race Condition)
**상황**: 여러 탭에서 동시에 검사 시작

**처리**:
1. DB 트랜잭션으로 동시성 제어
2. `remaining_tests` 차감을 원자적 연산으로 처리
3. 첫 번째 요청만 성공

**출력**:
- 이후 요청은 "잔여 횟수 부족" 에러
- 또는 "이미 진행 중인 검사가 있습니다"

---

## 7. UI 컴포넌트

### 7.1 폼 레이아웃
```
┌─────────────────────────────────────┐
│  새 사주 검사                        │
├─────────────────────────────────────┤
│                                     │
│  이름                               │
│  [___________________________]      │
│                                     │
│  생년월일                           │
│  [____/__/__] 📅                   │
│                                     │
│  출생시간                           │
│  [__:__] 🕐  AM/PM                 │
│  ☐ 출생시간 모름                    │
│                                     │
│  성별                               │
│  ◯ 남성  ◯ 여성                    │
│                                     │
│  [    검사 시작    ]                │
│                                     │
└─────────────────────────────────────┘
```

### 7.2 로딩 UI
```
┌─────────────────────────────────────┐
│                                     │
│         🔮                          │
│                                     │
│  AI가 당신의 사주를 분석하고        │
│  있습니다...                        │
│                                     │
│  ████████████░░░░░ 75%              │
│                                     │
│  잠시만 기다려주세요                │
│                                     │
└─────────────────────────────────────┘
```

---

## 8. 데이터베이스 변경사항

### 8.1 영향받는 테이블
- `tests`: INSERT (신규 검사 레코드 생성)
- `tests`: UPDATE (AI 분석 결과 저장)
- `subscriptions`: UPDATE (잔여 횟수 차감)

### 8.2 주요 쿼리 성능
- 구독 조회: `user_id` 인덱스 활용 (빠름)
- 검사 INSERT: 단일 레코드 (빠름)
- 횟수 차감: 단일 UPDATE (빠름)

---

## 9. 외부 API 연동

### 9.1 Gemini API
- **모델**: `gemini-2.5-flash` (Free) / `gemini-2.5-pro` (Pro)
- **환경변수**: `GEMINI_API_KEY`
- **타임아웃**: 30초
- **에러 처리**: 재시도 1회
- **Rate Limit**: 모니터링 필요 (429 에러 대응)

### 9.2 비용 예상
- Flash 모델: 무료 또는 저비용
- Pro 모델: 유료 (구독 수익으로 커버)

---

## 10. 보안 고려사항

### 10.1 인증
- Clerk 세션 검증 필수
- JWT 토큰 기반 사용자 식별

### 10.2 데이터 검증
- 서버 측 필수 필드 검증
- SQL Injection 방지 (파라미터화된 쿼리)
- XSS 방지 (마크다운 렌더링 시 sanitize)

### 10.3 Rate Limiting
- 동일 사용자의 과도한 요청 제한
- 1분당 최대 3회 검사 시도 (향후 구현)

---

## 11. 성능 목표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 폼 로드 시간 | 1초 이내 | Lighthouse |
| API 응답 시간 (DB only) | 500ms 이내 | 서버 로그 |
| Gemini API 응답 | 10초 이내 (평균) | 모니터링 |
| 전체 검사 완료 시간 | 15초 이내 | End-to-End 테스트 |

---

## 12. 테스트 시나리오

### 12.1 정상 플로우
1. Free 플랜 사용자로 로그인
2. 새 검사 페이지 진입
3. 모든 필드 정확히 입력
4. 검사 시작 클릭
5. 분석 완료 확인
6. 잔여 횟수 차감 확인 (3 → 2)

### 12.2 출생시간 없이 검사
1. 새 검사 페이지 진입
2. "출생시간 모름" 체크
3. 나머지 필드 입력
4. 검사 시작
5. 분석 결과에 "시간 미상" 반영 확인

### 12.3 잔여 횟수 0 시나리오
1. 잔여 횟수 0인 계정으로 로그인
2. 검사 시작 시도
3. 에러 모달 확인
4. "Pro로 업그레이드" 버튼 동작 확인

### 12.4 Pro 플랜 검사
1. Pro 플랜 사용자로 로그인
2. 검사 실행
3. Gemini Pro 모델 사용 확인
4. 더 상세한 분석 결과 확인

---

## 13. 모니터링 및 알림

### 13.1 로깅
- 검사 생성 이벤트
- Gemini API 호출 성공/실패
- 잔여 횟수 차감 이벤트
- 에러 발생 시 스택 트레이스

### 13.2 알림 대상
- Gemini API 429 에러 (Rate Limit)
- Gemini API 연속 실패 (3회 이상)
- DB 연결 실패

---

## 14. 향후 개선사항

### 14.1 Phase 1 (현재)
- 기본 폼 입력 및 AI 분석
- 잔여 횟수 관리

### 14.2 Phase 2 (향후)
- 검사 진행 상태 실시간 업데이트 (WebSocket)
- AI 분석 품질 평가 (별점)
- 분석 결과 PDF 다운로드

### 14.3 Phase 3 (미래)
- 여러 사람 일괄 검사 (CSV 업로드)
- 궁합 분석 (두 사람 비교)

---

## 15. 체크리스트

### 개발 전
- [ ] Gemini API 키 발급 확인
- [ ] Supabase 테이블 생성 확인
- [ ] Clerk 인증 연동 확인

### 개발 중
- [ ] 폼 컴포넌트 구현
- [ ] 캘린더/시간 선택 라이브러리 선택
- [ ] Gemini API 클라이언트 구현
- [ ] 에러 핸들링 구현
- [ ] 로딩 UI 구현

### 개발 후
- [ ] 정상 플로우 테스트
- [ ] 엣지케이스 테스트
- [ ] 성능 측정
- [ ] 보안 점검
- [ ] 모니터링 설정

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-12
**작성자**: Development Team
