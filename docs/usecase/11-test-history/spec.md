# 유스케이스 11: 검사 내역 영구 보관 및 조회

**프로젝트**: Saju피아 - AI 기반 사주팔자 분석 SaaS
**작성일**: 2025-12-12
**버전**: 1.0
**관련 문서**: `/docs/userflow.md` (섹션 11), `/docs/database.md`

---

## 1. 개요

### 1.1 목적
사용자가 수행한 모든 사주팔자 검사 내역을 영구적으로 보관하고, 언제든지 조회할 수 있도록 합니다.

### 1.2 범위
- 검사 내역 무제한 영구 보관
- 시간 제한 없이 과거 검사 결과 조회
- 대시보드 페이지네이션 처리
- 이름 기반 검색 기능

### 1.3 사용자 가치
- 과거 검사 결과를 언제든지 다시 확인 가능
- 여러 사람의 사주팔자를 체계적으로 관리
- 시간 경과에 따른 운세 변화 추적

---

## 2. 사용자 시나리오

### 시나리오 A: 오래된 검사 내역 조회
**상황**: 1년 전에 수행한 가족 구성원의 사주팔자 검사 결과를 다시 확인하고 싶음

**액터**: 기존 사용자 (Free 또는 Pro)

**전제조건**:
- 사용자가 로그인된 상태
- 과거에 1회 이상 검사를 수행한 이력 존재

**플로우**:
1. 사용자가 대시보드(`/dashboard`) 접속
2. 검사 내역 목록에서 원하는 검사 카드를 찾음
3. 검사 카드를 클릭하여 분석 상세보기 페이지로 이동
4. 과거 AI 분석 결과를 확인

**예상 결과**:
- 1년 전 검사 결과가 삭제되지 않고 보관됨
- 분석 내용이 완전히 보존되어 표시됨
- 검사 일시, 대상자 정보가 정확히 표시됨

---

### 시나리오 B: 대량 검사 내역 관리
**상황**: Pro 구독자가 6개월간 60회 이상의 검사를 수행하여 많은 내역이 누적됨

**액터**: Pro 구독자

**전제조건**:
- 60건 이상의 검사 내역 존재

**플로우**:
1. 대시보드 접속 시 최근 20건의 검사 내역이 표시됨
2. 페이지 하단까지 스크롤
3. 무한 스크롤 또는 "더보기" 버튼 클릭
4. 추가 20건의 검사 내역이 로드됨
5. 원하는 검사 내역을 찾을 때까지 반복

**예상 결과**:
- 초기 로딩 속도 유지 (최근 20건만 로드)
- 스크롤 시 부드러운 추가 로딩
- 모든 과거 내역에 접근 가능

---

### 시나리오 C: 이름 검색으로 빠른 조회
**상황**: 특정 사람(예: "김철수")의 사주팔자 검사 결과만 보고 싶음

**액터**: 다수의 검사 내역을 가진 사용자

**전제조건**:
- 여러 사람에 대한 검사 내역 존재

**플로우**:
1. 대시보드 접속
2. 검색창에 "김철수" 입력
3. 검색어가 포함된 검사 내역만 필터링되어 표시됨
4. 원하는 검사 카드 클릭

**예상 결과**:
- 실시간 검색 필터링 (타이핑 즉시 반영)
- "김철수"가 포함된 모든 검사 내역 표시
- 검색 결과 건수 표시 (예: "2건의 검사 내역")

---

## 3. 기능 요구사항

### FR-11.1: 검사 내역 영구 보관
**우선순위**: P0 (필수)

**설명**:
사용자가 수행한 모든 검사 내역을 기간 제한 없이 영구 보관합니다.

**Acceptance Criteria**:
- 검사 완료 시 Supabase `tests` 테이블에 영구 저장
- 사용자가 명시적으로 삭제하지 않는 한 데이터 보존
- Free 플랜과 Pro 플랜 모두 동일하게 영구 보관
- 구독 해지 후에도 과거 검사 내역 유지
- 검사 내역에 다음 정보 포함:
  - 대상자 이름
  - 생년월일
  - 출생시간 (입력한 경우)
  - 성별
  - AI 분석 결과 (마크다운)
  - 검사 일시

**비기능 요구사항**:
- 저장 용량 제한 없음 (Supabase 요금제 범위 내)
- 데이터 정합성 보장 (Foreign Key 제약)
- Row Level Security 적용으로 타인 접근 차단

---

### FR-11.2: 대시보드 검사 내역 조회
**우선순위**: P0 (필수)

**설명**:
사용자가 대시보드에서 자신의 모든 검사 내역을 최신순으로 조회합니다.

**Acceptance Criteria**:
- `/dashboard` 페이지에서 검사 내역 목록 표시
- 최신 검사가 최상단에 표시 (내림차순 정렬)
- 각 카드에 다음 정보 표시:
  - 대상자 이름
  - 생년월일
  - 검사 일시 (예: "2024년 1월 15일")
  - 사용 모델 배지 (Flash/Pro - 옵션)
- 카드 클릭 시 `/analysis/[id]` 페이지로 이동
- 총 검사 건수 표시 (예: "총 25건의 검사 내역")

**UI 요구사항**:
- 카드 그리드 레이아웃 (반응형)
- 호버 시 하이라이트 효과
- 빈 상태 처리: "아직 검사 내역이 없습니다. 새 검사를 시작해보세요!"

---

### FR-11.3: 페이지네이션 (무한 스크롤 또는 더보기)
**우선순위**: P1 (중요)

**설명**:
검사 내역이 많을 때 초기 로딩 속도를 유지하기 위해 페이지네이션을 구현합니다.

**Acceptance Criteria**:
- 초기 로드 시 최근 20건만 조회
- 무한 스크롤 방식 (권장):
  - 페이지 하단 도달 시 자동으로 다음 20건 로드
  - 로딩 중 스피너 표시
- 또는 "더보기" 버튼 방식:
  - 버튼 클릭 시 다음 20건 로드
  - 모든 내역 로드 완료 시 버튼 숨김
- 서버 측 페이지네이션:
  - `LIMIT 20 OFFSET N` 쿼리 사용
  - 총 검사 건수 반환 (hasMore 플래그)

**성능 목표**:
- 초기 로딩 시간 1초 이내 (20건 기준)
- 추가 로딩 시간 500ms 이내

---

### FR-11.4: 이름 기반 검색
**우선순위**: P1 (중요)

**설명**:
검색창에서 대상자 이름으로 검사 내역을 필터링합니다.

**Acceptance Criteria**:
- 대시보드 상단에 검색창 표시
- 플레이스홀더: "성함으로 검색하세요"
- 실시간 검색 (타이핑 즉시 필터링):
  - 클라이언트 측 필터링 (검사 내역 < 100건)
  - 또는 서버 측 검색 (검사 내역 >= 100건)
- 부분 일치 검색 (대소문자 구분 없음):
  - "철수" 입력 시 "김철수", "이철수" 모두 표시
- 검색 결과 건수 표시:
  - "검색 결과: 3건"
- 검색어 초기화 버튼 (X 아이콘)

**엣지케이스**:
- 검색 결과 없을 때: "검색 결과가 없습니다"
- 특수문자 입력: 정상 처리 (이름에 특수문자 가능)
- 빈 검색어: 전체 내역 표시

---

### FR-11.5: 분석 상세보기
**우선순위**: P0 (필수)

**설명**:
검사 카드 클릭 시 AI 분석 결과를 상세히 표시합니다.

**Acceptance Criteria**:
- `/api/test/[id]` GET 요청으로 검사 데이터 조회
- 접근 권한 검증:
  - 본인의 검사만 조회 가능 (RLS 또는 서버 검증)
  - 타인 검사 접근 시 403 Forbidden
- 존재하지 않는 ID 접근 시 404 Not Found
- 분석 결과가 NULL인 경우 안내 메시지:
  - "분석 결과가 아직 준비되지 않았습니다"
- 마크다운 렌더링 (`react-markdown`):
  - 제목 (H1, H2, H3) 스타일
  - 리스트, 인용구, 강조 스타일
  - 코드 블록 (해당 시)

**보안 요구사항**:
- Row Level Security (RLS) 적용
- `user_id` 일치 확인

---

## 4. 데이터 모델

### 4.1 tests 테이블 (Supabase)
```sql
CREATE TABLE tests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  birth_date DATE NOT NULL,
  birth_time TIME,
  gender gender_type NOT NULL,
  analysis_result TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### 4.2 주요 인덱스
```sql
-- 대시보드 쿼리 최적화 (user_id + 최신순)
CREATE INDEX idx_tests_user_id_created ON tests(user_id, created_at DESC);

-- 이름 검색 최적화
CREATE INDEX idx_tests_name ON tests(name);
```

---

## 5. API 명세

### 5.1 검사 내역 목록 조회
**엔드포인트**: `GET /api/test/list`

**쿼리 파라미터**:
- `limit` (number, 선택): 페이지 크기 (기본값: 20)
- `offset` (number, 선택): 오프셋 (기본값: 0)
- `search` (string, 선택): 이름 검색어

**응답 (200 OK)**:
```json
{
  "tests": [
    {
      "id": "uuid",
      "name": "김철수",
      "birth_date": "1990-01-15",
      "birth_time": "14:30:00",
      "gender": "male",
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "total": 25,
  "hasMore": true
}
```

---

### 5.2 검사 상세 조회
**엔드포인트**: `GET /api/test/[id]`

**응답 (200 OK)**:
```json
{
  "id": "uuid",
  "name": "김철수",
  "birth_date": "1990-01-15",
  "birth_time": "14:30:00",
  "gender": "male",
  "analysis_result": "# 사주팔자 분석 결과\n\n## 천간·지지\n...",
  "created_at": "2024-01-15T10:30:00Z"
}
```

**에러 응답**:
- `403 Forbidden`: 본인 검사가 아님
- `404 Not Found`: 존재하지 않는 검사 ID

---

## 6. 엣지케이스 및 예외 처리

### Case 6.1: 검사 내역이 매우 많을 때 (100건 이상)
**처리**:
- 페이지네이션으로 초기 로딩 속도 유지
- 서버 측 LIMIT/OFFSET 쿼리

**출력**:
- 초기 20건만 표시
- 무한 스크롤 또는 "더보기" 버튼

---

### Case 6.2: 검사 내역 없음 (신규 사용자)
**처리**:
- 빈 배열 반환 (`tests: []`)

**출력**:
- "아직 검사 내역이 없습니다. 새 검사를 시작해보세요!"
- "새 검사 시작" 버튼 표시

---

### Case 6.3: 이름 검색 결과 없음
**처리**:
- 빈 배열 반환

**출력**:
- "검색 결과가 없습니다"
- "검색어를 확인하거나 초기화해주세요"
- 검색어 초기화 버튼

---

### Case 6.4: 타인의 검사 접근 시도
**처리**:
- RLS 정책으로 차단
- 또는 서버 측 `user_id` 검증

**출력**:
- 403 Forbidden 에러
- "접근 권한이 없습니다"
- "대시보드로 돌아가기" 버튼

---

### Case 6.5: 존재하지 않는 검사 ID
**처리**:
- Supabase 조회 결과 없음

**출력**:
- 404 Not Found 에러 페이지
- "검사를 찾을 수 없습니다"

---

### Case 6.6: AI 분석 실패로 analysis_result가 NULL
**처리**:
- 서버에서 `analysis_result = null` 감지
- 정상 200 응답이지만 특수 플래그 전달

**출력**:
- "분석 결과가 아직 준비되지 않았습니다"
- "대시보드로 돌아가기" 버튼

---

### Case 6.7: 검사 내역이 1년 이상 오래된 경우
**처리**:
- 일반 검사와 동일하게 처리
- 생성일 표시 (예: "2023년 1월 15일")

**출력**:
- 정상적으로 분석 결과 표시
- 오래된 날짜 강조 (옵션)

---

### Case 6.8: 마크다운 형식 오류 (Gemini 응답 이상)
**처리**:
- `react-markdown` 파서의 에러 방지 모드
- 렌더링 실패 시 플레인 텍스트로 폴백

**출력**:
- 가능한 한 마크다운 렌더링
- 실패 시 원본 텍스트 표시

---

## 7. UI/UX 가이드라인

### 7.1 대시보드 레이아웃
```
┌─────────────────────────────────────────────┐
│ 과거에 수행한 사주 팔자 검사 내역을 확인할  │
│ 수 있습니다.                                │
│                                             │
│ [🔍 성함으로 검색하세요_______________]      │
│                                             │
│ 총 25건의 검사 내역                          │
│                                             │
│ ┌──────┐ ┌──────┐ ┌──────┐                │
│ │ 김철수│ │ 이영희│ │ 박민수│                │
│ │90.1.15│ │85.3.20│ │92.7.10│                │
│ │24.1.15│ │24.1.10│ │24.1.05│                │
│ └──────┘ └──────┘ └──────┘                │
│                                             │
│ [더보기]                                     │
└─────────────────────────────────────────────┘
```

### 7.2 검사 카드 구성
- **이름**: 큰 글씨, 볼드체
- **생년월일**: 작은 글씨, 회색
- **검사 일시**: 작은 글씨, 연한 회색
- **모델 배지** (옵션): Flash/Pro 표시

### 7.3 무한 스크롤 로딩 UI
- 스피너 아이콘
- "추가 검사 내역을 불러오는 중..." 텍스트

---

## 8. 비기능 요구사항

### NFR-11.1: 성능
- 초기 검사 내역 로딩: 1초 이내 (20건)
- 추가 페이지 로딩: 500ms 이내
- 이름 검색 필터링: 100ms 이내 (클라이언트 측)

### NFR-11.2: 보안
- RLS 정책으로 타인 검사 접근 차단
- 서버 측 `user_id` 검증 (이중 방어)
- SQL Injection 방지 (파라미터화된 쿼리)

### NFR-11.3: 확장성
- 검사 내역 1,000건 이상에서도 성능 유지
- 인덱스 최적화로 쿼리 속도 보장

### NFR-11.4: 데이터 보존
- 사용자가 명시적으로 삭제하지 않는 한 영구 보관
- 백업 정책 (Supabase Point-in-Time Recovery)

---

## 9. 구현 우선순위

### Phase 1 (필수)
1. `tests` 테이블 생성 및 인덱스 설정
2. 검사 내역 목록 조회 API (`/api/test/list`)
3. 검사 상세 조회 API (`/api/test/[id]`)
4. 대시보드 UI (카드 그리드)
5. 분석 상세보기 페이지
6. RLS 정책 적용

### Phase 2 (중요)
7. 페이지네이션 (무한 스크롤 또는 더보기)
8. 이름 검색 기능

### Phase 3 (선택)
9. 사용 모델 배지 표시 (Flash/Pro)
10. 검사 결과 다운로드 (PDF, 마크다운)

---

## 10. 테스트 시나리오

### 테스트 1: 영구 보관 확인
1. 신규 사용자 가입
2. 검사 1건 수행
3. 1년 후 대시보드 접속
4. 검사 내역이 여전히 존재하는지 확인

**예상 결과**: 검사 내역 정상 표시

---

### 테스트 2: 대량 검사 내역 성능
1. Pro 사용자 계정 준비
2. 검사 100건 생성 (시드 데이터)
3. 대시보드 접속
4. 초기 로딩 시간 측정

**예상 결과**: 1초 이내 로딩

---

### 테스트 3: 이름 검색
1. 여러 이름의 검사 내역 생성 (김철수, 이영희, 박민수)
2. 대시보드에서 "철수" 검색
3. "김철수" 검사만 표시되는지 확인

**예상 결과**: 검색 결과 1건

---

### 테스트 4: 타인 접근 차단
1. 사용자 A의 검사 ID 확보
2. 사용자 B로 로그인
3. `/analysis/[사용자A의 검사ID]` 접근 시도

**예상 결과**: 403 Forbidden

---

## 11. 관련 문서
- `/docs/userflow.md` - 섹션 11 (검사 내역 영구 보관 및 조회)
- `/docs/database.md` - tests 테이블 스키마
- `/docs/prd.md` - 섹션 9.2 (대시보드 페이지 명세)

---

## 12. 변경 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 1.0  | 2025-12-12 | Claude Code | 초안 작성 |

---

**문서 작성 완료**
