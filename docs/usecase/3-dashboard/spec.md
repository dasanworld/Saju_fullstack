# UC-003: 대시보드 검사 내역 조회

**기능명**: 대시보드 검사 내역 조회 (Dashboard Test History)
**우선순위**: P0 (필수)
**관련 페이지**: `/dashboard`
**관련 API**: `/api/test/list`

---

## 1. 개요

사용자가 과거에 수행한 사주팔자 검사 내역을 조회하고, 이름으로 검색하며, 특정 검사의 상세 결과를 확인할 수 있는 기능입니다.

### 1.1 목적
- 사용자가 과거 검사 내역을 쉽게 찾고 재확인할 수 있도록 지원
- 이름 검색을 통한 빠른 필터링 제공
- 검사 내역 영구 보관 정책 구현

### 1.2 범위
- 사용자별 검사 내역 목록 조회
- 이름 기반 실시간 검색
- 검사 카드 클릭 시 상세 페이지 이동
- 페이지네이션 또는 무한 스크롤 (검사 내역 100건 이상 시)

---

## 2. 사용자 플로우

### 2.1 기본 플로우

```
[로그인 완료]
    ↓
[Global Nav에서 "대시보드" 클릭]
    ↓
[/dashboard 페이지 진입]
    ↓
[API 호출: GET /api/test/list]
    ↓
[검사 내역 카드 리스트 렌더링]
    ↓
[카드 클릭]
    ↓
[/analysis/[id] 상세 페이지로 이동]
```

### 2.2 검색 플로우

```
[대시보드 페이지 진입]
    ↓
[검색창에 이름 입력]
    ↓
[클라이언트 측 실시간 필터링]
    ↓
[검색 결과 카드만 표시]
    ↓
(검색어 초기화 시)
    ↓
[전체 내역 다시 표시]
```

---

## 3. 입력 및 출력

### 3.1 입력

#### 3.1.1 페이지 진입
- **트리거**: Global Nav에서 "대시보드" 메뉴 클릭
- **사전 조건**:
  - 사용자 로그인 상태 (Clerk 인증)
  - 유효한 세션 토큰

#### 3.1.2 검색
- **입력 필드**: 검색창 (텍스트 입력)
- **플레이스홀더**: "성함으로 검색하세요"
- **검색어 형식**: 모든 문자 허용 (특수문자 포함)
- **검색 동작**: 입력 즉시 실시간 필터링

### 3.2 처리

#### 3.2.1 서버 측 처리
1. 인증 확인
   - Clerk 세션 토큰 검증
   - 사용자 ID 추출

2. 데이터 조회
   ```sql
   SELECT
     id,
     name,
     birth_date,
     birth_time,
     gender,
     created_at
   FROM tests
   WHERE user_id = $1
   ORDER BY created_at DESC
   LIMIT 20;
   ```

3. 응답 반환
   ```typescript
   {
     tests: Test[],
     total: number
   }
   ```

#### 3.2.2 클라이언트 측 처리
1. API 응답 수신
2. 검사 카드 렌더링
3. 총 검사 건수 표시
4. 검색어 입력 시 클라이언트 필터링
   ```typescript
   const filtered = tests.filter(test =>
     test.name.toLowerCase().includes(searchQuery.toLowerCase())
   );
   ```

### 3.3 출력

#### 3.3.1 페이지 구성
- **상단 헤더**: "과거에 수행한 사주 팔자 검사 내역을 확인할 수 있습니다."
- **검색 영역**: 검색창 + 돋보기 아이콘
- **통계 정보**: "총 N건의 검사 내역"
- **카드 리스트**: 검사 내역 카드 그리드

#### 3.3.2 검사 카드 UI
각 카드 포함 정보:
- 이름 (검사 대상자)
- 생년월일 (YYYY년 MM월 DD일)
- 검사 일시 (YYYY-MM-DD HH:MM)
- 사용 모델 배지 (Flash/Pro)
  - Free 플랜: "Flash" 배지
  - Pro 플랜: "Pro" 배지

#### 3.3.3 빈 상태 (Empty State)
검사 내역이 없을 때:
- 메시지: "아직 검사 내역이 없습니다. 새 검사를 시작해보세요!"
- CTA 버튼: "새 검사 시작" → `/new-test`로 이동

#### 3.3.4 검색 결과 없음
검색 결과가 없을 때:
- 메시지: "검색 결과가 없습니다"
- 안내: "검색어를 확인하거나 초기화해주세요"
- 검색어 초기화 (X) 버튼

---

## 4. 엣지 케이스

### 4.1 검사 내역이 매우 많을 때 (100건 이상)

**시나리오**: 사용자가 장기간 서비스를 이용하여 100건 이상의 검사 내역 보유

**처리**:
- 서버 측 페이지네이션 구현 (20건씩 로드)
- 무한 스크롤 또는 "더보기" 버튼 제공
- 초기 로드 시 최신 20건만 표시

**출력**:
- 스크롤 또는 버튼 클릭 시 추가 데이터 로드
- 로딩 스피너 표시
- 스크롤 위치 유지

**근거**: PRD 6.3.3, userflow 3.4.1

---

### 4.2 API 요청 실패 (네트워크 오류)

**시나리오**: 네트워크 불안정으로 API 요청 실패

**처리**:
- 클라이언트에서 에러 캐치
- 재시도 로직 구현 (최대 3회, 지수 백오프)
- 모든 재시도 실패 시 에러 UI 표시

**출력**:
- 에러 메시지: "검사 내역을 불러올 수 없습니다"
- "다시 시도" 버튼 제공
- 에러 로그 기록

**근거**: userflow 3.4.2

---

### 4.3 검색어 입력 후 결과 없음

**시나리오**: 사용자가 검색어를 입력했으나 일치하는 결과 없음

**처리**:
- 클라이언트 측 필터링으로 빈 배열 반환
- 검색 결과 없음 UI 표시

**출력**:
- 메시지: "검색 결과가 없습니다"
- 안내: "검색어를 확인하거나 초기화해주세요"
- 검색어 초기화 (X) 버튼 표시
- 클릭 시 전체 내역 다시 표시

**근거**: userflow 3.4.3

---

### 4.4 검색어에 특수문자 포함

**시나리오**: 사용자가 이름에 특수문자가 포함된 검색어 입력 (예: "김○○", "홍-길동")

**처리**:
- 클라이언트 측에서 특수문자 허용 (이름에 포함될 수 있음)
- 서버 측 검색 시 파라미터화된 쿼리 사용 (SQL Injection 방지)

**출력**:
- 정상적으로 검색 수행
- 특수문자가 포함된 이름도 필터링

**근거**: userflow 3.4.4

---

### 4.5 비인증 사용자 접근 시도

**시나리오**: 미인증 사용자가 직접 URL로 `/dashboard` 접근 시도

**처리**:
- Next.js Middleware에서 인증 상태 확인
- 미인증 사용자 감지

**출력**:
- Clerk 로그인 페이지로 리다이렉트
- 로그인 완료 후 `/dashboard`로 다시 리다이렉트

**근거**: requirement 기능 섹션, userflow 2.4.7

---

### 4.6 검사 카드 클릭 시 존재하지 않는 ID

**시나리오**: 검사 ID가 삭제되었거나 손상된 경우 (드물지만 가능)

**처리**:
- `/analysis/[id]` 페이지에서 404 처리
- 서버에서 검사 데이터 조회 결과 없음

**출력**:
- "검사를 찾을 수 없습니다" 에러 페이지
- "대시보드로 돌아가기" 버튼

**근거**: userflow 4.4.1

---

### 4.7 여러 탭에서 동시 사용

**시나리오**: 사용자가 여러 브라우저 탭에서 대시보드 동시 접근

**처리**:
- 각 탭이 독립적으로 API 호출
- 페이지 전환 시 최신 정보 조회

**출력**:
- 탭 간 정보 불일치 가능 (단기적)
- 페이지 새로고침 시 동기화됨

**근거**: userflow 13.4.2

---

## 5. 데이터베이스 스키마

### 5.1 관련 테이블

#### tests 테이블
```sql
CREATE TABLE tests (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id),
  name TEXT NOT NULL,
  birth_date DATE NOT NULL,
  birth_time TIME,
  gender gender_type NOT NULL,
  analysis_result TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_tests_user_id_created ON tests(user_id, created_at DESC);
CREATE INDEX idx_tests_name ON tests(name);
```

### 5.2 쿼리

#### 전체 내역 조회 (페이지네이션)
```sql
SELECT
  id,
  name,
  birth_date,
  birth_time,
  gender,
  created_at
FROM tests
WHERE user_id = $1
ORDER BY created_at DESC
LIMIT 20 OFFSET $2;
```

#### 총 검사 건수
```sql
SELECT COUNT(*) as total
FROM tests
WHERE user_id = $1;
```

#### 이름 검색 (서버 측 구현 시)
```sql
SELECT
  id,
  name,
  birth_date,
  created_at
FROM tests
WHERE user_id = $1
  AND name ILIKE '%' || $2 || '%'
ORDER BY created_at DESC;
```

---

## 6. API 명세

### 6.1 GET /api/test/list

#### Request
```typescript
// Headers
Authorization: Bearer <clerk_token>

// Query Parameters (선택)
interface QueryParams {
  page?: number;      // 페이지 번호 (기본값: 1)
  limit?: number;     // 페이지당 항목 수 (기본값: 20)
  search?: string;    // 이름 검색어 (선택)
}
```

#### Response (성공)
```typescript
// Status: 200 OK
interface ListTestsResponse {
  tests: Array<{
    id: string;
    name: string;
    birthDate: string;      // ISO 8601
    birthTime?: string;     // HH:MM 형식
    gender: 'male' | 'female';
    createdAt: string;      // ISO 8601
  }>;
  total: number;
  page: number;
  limit: number;
}
```

#### Response (에러)
```typescript
// Status: 401 Unauthorized
{
  error: "Unauthorized",
  message: "유효하지 않은 인증 토큰입니다"
}

// Status: 500 Internal Server Error
{
  error: "Internal Server Error",
  message: "검사 내역을 불러오는 중 오류가 발생했습니다"
}
```

---

## 7. UI/UX 요구사항

### 7.1 레이아웃
- **좌측 Global Nav**: 공통 네비게이션 (Saju피아 로고, 대시보드, 새 검사)
- **메인 컨텐츠 영역**: 중앙 정렬, 최대 너비 1200px

### 7.2 검색창
- **위치**: 상단 헤더 바로 아래
- **너비**: 메인 컨텐츠 영역 전체 너비
- **아이콘**: 좌측에 돋보기 아이콘
- **플레이스홀더**: "성함으로 검색하세요"
- **동작**: 입력 즉시 실시간 필터링 (디바운스 300ms)

### 7.3 검사 카드
- **레이아웃**: 그리드 (데스크탑 3열, 태블릿 2열, 모바일 1열)
- **간격**: 16px
- **배경**: 흰색 카드, 호버 시 그림자 효과
- **커서**: 포인터 (클릭 가능)
- **정보 배치**:
  - 상단: 이름 (큰 글씨, 볼드)
  - 중단: 생년월일, 출생시간 (작은 글씨)
  - 하단: 검사 일시, 모델 배지

### 7.4 모델 배지
- **Flash 배지**: 연한 회색 배경, 검은색 텍스트
- **Pro 배지**: 보라색 배경, 흰색 텍스트

### 7.5 Notion 스타일
- 심플한 인터페이스
- 넓은 여백 (패딩)
- 중성적인 색상 (흰색, 회색, 검은색)
- 둥근 모서리 (border-radius: 8px)

---

## 8. 성능 요구사항

### 8.1 응답 시간
- **API 응답 시간**: 1초 이내 (100개 기준)
- **페이지 로드**: 3초 이내 (First Contentful Paint)

### 8.2 최적화
- 복합 인덱스 사용 (`idx_tests_user_id_created`)
- 클라이언트 측 검색 (서버 부하 감소)
- 페이지네이션으로 데이터 로드 최소화

---

## 9. 보안 요구사항

### 9.1 인증
- Clerk 세션 토큰 필수
- 만료된 토큰 감지 시 자동 로그아웃

### 9.2 권한
- Row Level Security (RLS)로 타 사용자 데이터 접근 방지
- 사용자는 자신의 검사 내역만 조회 가능

### 9.3 SQL Injection 방지
- 파라미터화된 쿼리 사용
- 검색어 입력값 검증 (서버 측)

---

## 10. 테스트 시나리오

### 10.1 정상 플로우 테스트
1. 로그인 후 대시보드 진입
2. 검사 내역 10건 표시 확인
3. 총 건수 표시 확인
4. 카드 클릭 시 상세 페이지 이동 확인

### 10.2 검색 기능 테스트
1. 검색창에 "홍길동" 입력
2. 일치하는 결과만 필터링 확인
3. 검색어 초기화 버튼 클릭
4. 전체 내역 다시 표시 확인

### 10.3 빈 상태 테스트
1. 검사 내역이 없는 신규 사용자로 로그인
2. 빈 상태 메시지 확인
3. "새 검사 시작" 버튼 클릭
4. `/new-test` 페이지로 이동 확인

### 10.4 에러 처리 테스트
1. 네트워크 차단 후 대시보드 진입
2. 에러 메시지 표시 확인
3. "다시 시도" 버튼 클릭
4. 네트워크 복구 후 정상 로드 확인

### 10.5 페이지네이션 테스트
1. 검사 내역 100건 생성
2. 초기 로드 시 20건만 표시 확인
3. 스크롤 하단 도달 시 추가 20건 로드 확인
4. 로딩 스피너 표시 확인

---

## 11. 접근성 (Accessibility)

### 11.1 키보드 네비게이션
- Tab 키로 검사 카드 간 이동
- Enter 키로 카드 선택 (상세 페이지 이동)

### 11.2 ARIA 레이블
- 검색창: `aria-label="검사 내역 검색"`
- 검사 카드: `role="button"`, `aria-label="[이름] 검사 상세보기"`

### 11.3 스크린 리더
- 검사 건수 읽기: "총 N건의 검사 내역"
- 검색 결과: "검색 결과 N건"

---

## 12. 관련 문서

- **요구사항**: `/docs/requirement.md` - 대시보드 섹션
- **PRD**: `/docs/prd.md` - 9.2 대시보드 (분석 목록)
- **사용자 플로우**: `/docs/userflow.md` - 3. 대시보드 검사 내역 조회
- **데이터베이스**: `/docs/database.md` - 2.3 tests 테이블
- **관련 UC**:
  - UC-004: 분석 상세보기 (카드 클릭 후 이동)
  - UC-002: 새 검사 생성 (빈 상태에서 이동)

---

## 13. 체크리스트

### 백엔드
- [ ] `/api/test/list` API 구현
- [ ] Clerk 인증 검증
- [ ] RLS 정책 적용
- [ ] 페이지네이션 구현
- [ ] 에러 핸들링

### 프론트엔드
- [ ] 대시보드 페이지 UI 구현
- [ ] 검색창 + 실시간 필터링
- [ ] 검사 카드 컴포넌트
- [ ] 빈 상태 UI
- [ ] 검색 결과 없음 UI
- [ ] 로딩 스피너
- [ ] 페이지네이션 또는 무한 스크롤
- [ ] 반응형 디자인 (모바일/태블릿/데스크탑)

### 테스트
- [ ] 단위 테스트 (API)
- [ ] 통합 테스트 (페이지 로드)
- [ ] E2E 테스트 (검색 플로우)
- [ ] 성능 테스트 (100건 이상)

---

**문서 버전**: 1.0
**작성일**: 2025-12-12
**작성자**: Product Team
