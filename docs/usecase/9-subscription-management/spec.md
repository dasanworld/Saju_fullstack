# 유스케이스 9: 구독 관리 페이지 조회

**기능 번호**: UC-009
**기능명**: 구독 관리 페이지 조회
**작성일**: 2025-12-12
**버전**: 1.0

---

## 1. 개요

### 1.1 목적
사용자가 현재 구독 상태를 확인하고 Pro 플랜으로 업그레이드하거나 구독을 관리할 수 있도록 구독 정보를 조회하는 페이지를 제공합니다.

### 1.2 범위
- 현재 구독 정보 조회 (Free/Pro)
- 플랜별 UI 차별화
- 업그레이드 유도 (Free 플랜 사용자)
- 구독 취소 상태 표시 (Pro 플랜 취소 예약 사용자)

### 1.3 관련 페이지
- `/subscription` - 구독 관리 페이지

### 1.4 관련 API
- `GET /api/subscription/status` - 구독 정보 조회

---

## 2. 사용자 시나리오

### 2.1 메인 시나리오: Free 플랜 사용자
1. 사용자가 Global Navigation 하단의 구독 정보 영역을 클릭
2. `/subscription` 페이지로 이동
3. 시스템이 사용자의 구독 정보를 조회
4. Free 플랜 정보 카드와 Pro 업그레이드 유도 카드가 표시됨
5. 사용자는 잔여 횟수와 사용 모델 정보를 확인

### 2.2 메인 시나리오: Pro 플랜 사용자 (정상 구독)
1. 사용자가 구독 관리 페이지에 접근
2. Pro 플랜 정보 카드가 표시됨
3. 사용자는 잔여 횟수, 다음 결제일, 사용 모델 정보를 확인
4. 필요시 "구독 취소" 버튼을 통해 취소 가능

### 2.3 메인 시나리오: Pro 플랜 사용자 (취소 예정)
1. 사용자가 구독 관리 페이지에 접근
2. Pro 플랜 정보 카드에 "취소 예정" 상태가 표시됨
3. 다음 구독 종료일과 안내 메시지가 표시됨
4. "취소 철회" 버튼을 통해 취소를 철회할 수 있음

---

## 3. 입력

### 3.1 사용자 입력
- **진입 경로**:
  - Global Navigation 하단의 구독 정보 영역 클릭
  - "Pro로 업그레이드" 안내 버튼 클릭
  - 대시보드의 업그레이드 유도 버튼 클릭

### 3.2 시스템 입력
- **인증 정보**: Clerk 세션 토큰
- **사용자 ID**: 현재 로그인된 사용자의 UUID

---

## 4. 처리 과정

### 4.1 페이지 진입
1. 사용자가 `/subscription` 경로로 접근
2. Next.js Middleware가 인증 상태 확인
3. 인증되지 않은 경우 Clerk 로그인 페이지로 리다이렉트

### 4.2 구독 정보 조회
1. 클라이언트가 `GET /api/subscription/status` 요청
2. 서버가 Clerk 세션을 검증
3. Supabase에서 현재 사용자의 구독 정보 조회:
   ```sql
   SELECT
     plan,
     remaining_tests,
     billing_key IS NOT NULL AS has_billing_key,
     next_billing_date,
     cancel_at_period_end
   FROM subscriptions
   WHERE user_id = $1;
   ```
4. 조회된 데이터를 클라이언트로 반환

### 4.3 UI 렌더링
플랜 타입과 상태에 따라 적절한 UI 컴포넌트 표시

---

## 5. 출력

### 5.1 Free 플랜 사용자 UI

#### 현재 구독 정보 카드
- **제목**: "Free 플랜"
- **잔여 횟수**: `X/3` 형식으로 표시
- **사용 모델**: "Gemini 2.5 Flash"
- **혜택 목록**:
  - 가입 즉시 3회 무료 검사
  - Gemini 2.5 Flash 모델 사용
  - 검사 내역 영구 보관
  - 마크다운 형식 분석 결과

#### 업그레이드 유도 카드
- **제목**: "Pro 플랜으로 업그레이드하세요!"
- **Pro 혜택 강조**:
  - 월 10회 고품질 검사
  - Gemini 2.5 Pro 모델 사용
  - 더 상세한 분석 결과
  - 월 3,900원 자동 결제
- **CTA 버튼**: "지금 시작하기" (Primary 스타일)
  - 클릭 시 토스페이먼츠 SDK 호출

### 5.2 Pro 플랜 사용자 UI (정상 구독)

#### 현재 구독 정보 카드
- **제목**: "Pro 플랜"
- **잔여 횟수**: `X/10` 형식으로 표시
- **다음 결제일**: "YYYY년 MM월 DD일" 형식
- **사용 모델**: "Gemini 2.5 Pro"
- **결제 정보**: "월 3,900원 자동 결제"
- **CTA 버튼**: "구독 취소" (Danger 스타일)
  - 클릭 시 구독 취소 확인 모달 표시

### 5.3 Pro 플랜 사용자 UI (취소 예정)

#### 현재 구독 정보 카드
- **제목**: "Pro 플랜"
- **상태 배지**: "취소 예정" (Warning 스타일)
- **안내 메시지**: "YYYY년 MM월 DD일에 구독이 종료됩니다"
- **잔여 횟수**: `X/10` (종료일까지 사용 가능)
- **세부 안내**:
  - 종료일까지 Pro 서비스 이용 가능
  - 다음 결제가 진행되지 않음
  - 종료 후 Free 플랜으로 전환
- **CTA 버튼**: "취소 철회" (Primary 스타일)
  - 클릭 시 취소 예약 상태 해제

---

## 6. 엣지케이스 및 오류 처리

### 6.1 구독 정보 조회 실패

#### 시나리오
API 요청 중 네트워크 오류 또는 서버 에러 발생

#### 처리
1. 클라이언트에서 에러 캐치
2. 재시도 로직 실행 (최대 3회)
3. 모든 재시도 실패 시 에러 UI 표시

#### 출력
- 에러 메시지: "구독 정보를 불러올 수 없습니다"
- "다시 시도" 버튼 제공
- 고객센터 연락처 안내

### 6.2 구독 데이터 없음

#### 시나리오
Supabase에 사용자의 구독 레코드가 없음 (비정상 상태)

#### 처리
1. 서버에서 구독 레코드 조회 결과 없음 감지
2. 404 Not Found 응답 반환

#### 출력
- 에러 메시지: "구독 정보를 찾을 수 없습니다"
- 안내 문구: "고객센터에 문의해주세요"
- 고객센터 이메일/전화 표시

### 6.3 만료된 Pro 구독

#### 시나리오
결제 실패 또는 구독 취소로 인해 Pro 플랜이 만료됨

#### 처리
1. 서버에서 `plan = 'free'` 및 `billing_key = NULL` 확인
2. Free 플랜으로 데이터 반환

#### 출력
- Free 플랜 UI 표시
- 안내 메시지: "이전에 Pro 구독을 이용하셨습니다. 다시 시작하시겠어요?"
- "Pro 시작하기" 버튼 제공

### 6.4 비인증 사용자 접근

#### 시나리오
로그인하지 않은 사용자가 `/subscription` 페이지 접근

#### 처리
1. Next.js Middleware에서 인증 상태 확인
2. 미인증 감지 시 리다이렉트

#### 출력
- Clerk 로그인 페이지로 리다이렉트
- 로그인 완료 후 `/subscription`으로 다시 리다이렉트

---

## 7. 비기능 요구사항

### 7.1 성능
- 구독 정보 조회 응답 시간 1초 이내
- 페이지 초기 로딩 시간 2초 이내

### 7.2 보안
- Clerk 세션 토큰 검증 필수
- Supabase RLS 정책으로 자신의 구독 정보만 조회 가능
- 빌링키는 클라이언트에 노출하지 않음 (서버에서만 사용)

### 7.3 사용성
- Notion 스타일 디자인 적용
- 반응형 웹 디자인 (모바일/태블릿/데스크탑)
- 명확한 정보 계층 구조
- 직관적인 CTA 버튼 배치

---

## 8. API 명세

### 8.1 GET /api/subscription/status

#### 요청
```http
GET /api/subscription/status
Authorization: Bearer {clerk_session_token}
```

#### 성공 응답 (200 OK)
```json
{
  "plan": "free" | "pro",
  "remaining_tests": 3,
  "next_billing_date": "2025-01-15" | null,
  "cancel_at_period_end": false,
  "has_billing_key": false
}
```

#### 에러 응답
- **401 Unauthorized**: 인증 실패
  ```json
  {
    "error": "Unauthorized",
    "message": "로그인이 필요합니다"
  }
  ```

- **404 Not Found**: 구독 정보 없음
  ```json
  {
    "error": "Not Found",
    "message": "구독 정보를 찾을 수 없습니다"
  }
  ```

- **500 Internal Server Error**: 서버 오류
  ```json
  {
    "error": "Internal Server Error",
    "message": "일시적인 오류가 발생했습니다"
  }
  ```

---

## 9. UI 컴포넌트

### 9.1 레이아웃
- **좌측**: Global Navigation
- **메인 영역**: 중앙 정렬된 카드 그리드

### 9.2 카드 디자인
- **배경**: 흰색 또는 연한 베이지 톤
- **모서리**: 둥근 모서리 (border-radius: 12px)
- **그림자**: 미세한 그림자 효과
- **여백**: 넉넉한 패딩 (24px)

### 9.3 색상 가이드
- **Primary**: Pro 업그레이드 버튼
- **Danger**: 구독 취소 버튼
- **Warning**: 취소 예정 배지
- **Success**: 정상 구독 상태 표시

---

## 10. 데이터베이스 쿼리

### 10.1 구독 정보 조회
```sql
SELECT
  plan,
  remaining_tests,
  billing_key IS NOT NULL AS has_billing_key,
  next_billing_date,
  cancel_at_period_end
FROM subscriptions
WHERE user_id = $1;
```

### 10.2 RLS 정책
```sql
CREATE POLICY subscriptions_policy ON subscriptions
  FOR ALL
  USING (
    user_id IN (
      SELECT id FROM users
      WHERE clerk_user_id = auth.jwt() ->> 'sub'
    )
  );
```

---

## 11. 테스트 시나리오

### 11.1 Free 플랜 사용자 테스트
1. Free 플랜 계정으로 로그인
2. 구독 관리 페이지 접근
3. Free 플랜 카드 표시 확인
4. 잔여 횟수 정확성 확인 (0~3)
5. Pro 업그레이드 유도 카드 표시 확인

### 11.2 Pro 플랜 사용자 테스트
1. Pro 플랜 계정으로 로그인
2. 구독 관리 페이지 접근
3. Pro 플랜 카드 표시 확인
4. 잔여 횟수 정확성 확인 (0~10)
5. 다음 결제일 표시 확인
6. "구독 취소" 버튼 표시 확인

### 11.3 취소 예정 상태 테스트
1. Pro 플랜 구독 취소 후 재접근
2. "취소 예정" 배지 표시 확인
3. 구독 종료일 표시 확인
4. "취소 철회" 버튼 표시 확인

### 11.4 에러 시나리오 테스트
1. 네트워크 단절 상태에서 접근
2. 에러 메시지 표시 확인
3. "다시 시도" 버튼 동작 확인

---

## 12. 의존성

### 12.1 외부 서비스
- **Clerk**: 인증 및 세션 관리
- **Supabase**: 구독 정보 저장 및 조회
- **토스페이먼츠**: Pro 구독 시작 시 빌링키 발급

### 12.2 관련 유스케이스
- **UC-005**: Pro 구독 시작 (업그레이드 버튼 연계)
- **UC-006**: 구독 취소 (취소 버튼 연계)
- **UC-007**: 구독 취소 철회 (철회 버튼 연계)

---

## 13. 향후 개선 사항

### 13.1 기능 개선
- 구독 이력 조회 기능 추가
- 결제 내역 확인 기능 추가
- 플랜 비교표 추가

### 13.2 UX 개선
- 구독 상태 변경 시 애니메이션 효과
- 실시간 잔여 횟수 업데이트 (WebSocket)
- 다음 결제일 알림 설정

---

## 14. 참고 문서

- `/docs/requirement.md` - 요구사항 정의
- `/docs/prd.md` - 제품 요구사항 문서
- `/docs/userflow.md` - 사용자 플로우 (섹션 9)
- `/docs/database.md` - 데이터베이스 설계

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-12
**작성자**: Claude Code
